{% extends "base.html" %}

{% block title %}Admin Dashboard - Care_4_U Hospitals{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
        <p class="welcome-message">Welcome back, {{ current_user.username }}!</p>
    </div>

    <!-- Admin Profile Card -->
    <div class="admin-profile-card">
        <div class="profile-section">
            <div class="profile-avatar">
                {% if current_user.profile_picture %}
                <img src="{{ url_for('serve_profile_picture', filename=current_user.profile_picture.split('/')[-1]) }}"
                    alt="{{ current_user.username }}">
                {% else %}
                <i class="fas fa-user-shield"></i>
                {% endif %}
                <button class="btn-upload-profile" onclick="document.getElementById('adminProfilePictureInput').click()"
                    title="Upload Profile Picture">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
            <input type="file" id="adminProfilePictureInput" accept="image/*" style="display: none;"
                onchange="uploadAdminProfilePicture()">
            <div class="profile-info">
                <h3>{{ current_user.username }}</h3>
                <p>{{ current_user.email }}</p>
                <p class="admin-role">Administrator</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon patients">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_patients }}</h3>
                <p>Total Patients</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon doctors">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_doctors }}</h3>
                <p>Active Doctors</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon appointments">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_appointments }}</h3>
                <p>Total Appointments</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon pending">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>{{ pending_appointments }}</h3>
                <p>Pending Approvals</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
        <div class="action-buttons">
            <button class="action-btn" data-action="add-doctor">
                <i class="fas fa-user-plus"></i>
                <span>Add New Doctor</span>
            </button>
            <button class="action-btn" data-action="view-reports">
                <i class="fas fa-chart-bar"></i>
                <span>View Reports</span>
            </button>
            <button class="action-btn" data-action="system-settings">
                <i class="fas fa-cog"></i>
                <span>System Settings</span>
            </button>
        </div>
    </div>

    <!-- Doctors List -->
    <div class="recent-section">
        <div class="section-header">
            <h2><i class="fas fa-user-md"></i> Doctors</h2>
        </div>

        {% if doctors %}
        <div class="appointments-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Specialization</th>
                        <th>Contact</th>
                        <th>Availability</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doctor in doctors %}
                    <tr>
                        <td>
                            <div class="patient-cell">
                                <strong>{{ doctor.name }}</strong>
                                <small>{{ doctor.qualifications }}</small>
                            </div>
                        </td>
                        <td>{{ doctor.specialization }}</td>
                        <td>
                            <div class="patient-cell">
                                <small>{{ doctor.email }}</small>
                                <small>{{ doctor.phone }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="datetime-cell">
                                <span class="date">{{ doctor.available_days }}</span>
                                <span class="time">{{ doctor.available_time }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm btn-primary" onclick="openEditDoctor(this)"
                                    data-id="{{ doctor.id }}" data-name="{{ doctor.name }}"
                                    data-specialization="{{ doctor.specialization }}"
                                    data-qualifications="{{ doctor.qualifications }}"
                                    data-experience="{{ doctor.experience }}" data-email="{{ doctor.email }}"
                                    data-phone="{{ doctor.phone }}" data-fee="{{ doctor.consultation_fee }}"
                                    data-days="{{ doctor.available_days }}" data-time="{{ doctor.available_time }}">
                                    Edit
                                </button>
                                <button class="btn-sm btn-danger" onclick="deleteDoctor('{{ doctor.id }}')">
                                    Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-data">
            <i class="fas fa-user-md"></i>
            <p>No doctors available</p>
        </div>
        {% endif %}
    </div>

    <!-- Users List (Categorized by Role) -->
    <div class="recent-section">
        <div class="section-header">
            <h2><i class="fas fa-users"></i> Manage Users</h2>
            <button class="btn btn-primary" data-action="add-user">
                <i class="fas fa-user-plus"></i> Add User
            </button>
        </div>

        {% if users %}
        <!-- Admins Section -->
        {% set admins = users|selectattr('role', 'equalto', 'admin')|list %}
        {% if admins %}
        <h3 style="margin-top: 20px; color: #e74c3c;"><i class="fas fa-user-shield"></i> Administrators</h3>
        <div class="appointments-table">
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in admins %}
                    <tr>
                        <td>
                            <div class="patient-cell">
                                <strong>{{ user.username }}</strong>
                            </div>
                        </td>
                        <td>
                            <div class="patient-cell">
                                <small>{{ user.email or 'N/A' }}</small>
                                <small>{{ user.phone or 'N/A' }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm btn-primary" onclick="openEditUser(this)"
                                    data-username="{{ user.username }}" data-email="{{ user.email }}"
                                    data-phone="{{ user.phone }}" data-role="{{ user.role }}">
                                    Edit
                                </button>
                                <button class="btn-sm btn-danger" onclick="deleteUser('{{ user.username }}')">
                                    Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Doctors Section -->
        {% set doctors_users = users|selectattr('role', 'equalto', 'doctor')|list %}
        {% if doctors_users %}
        <h3 style="margin-top: 20px; color: #3498db;"><i class="fas fa-user-md"></i> Doctors</h3>
        <div class="appointments-table">
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in doctors_users %}
                    <tr>
                        <td>
                            <div class="patient-cell">
                                <strong>{{ user.username }}</strong>
                            </div>
                        </td>
                        <td>
                            <div class="patient-cell">
                                <small>{{ user.email or 'N/A' }}</small>
                                <small>{{ user.phone or 'N/A' }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm btn-primary" onclick="openEditUser(this)"
                                    data-username="{{ user.username }}" data-email="{{ user.email }}"
                                    data-phone="{{ user.phone }}" data-role="{{ user.role }}">
                                    Edit
                                </button>
                                <button class="btn-sm btn-danger" onclick="deleteUser('{{ user.username }}')">
                                    Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Patients Section -->
        {% set patients = users|selectattr('role', 'equalto', 'user')|list %}
        {% if patients %}
        <h3 style="margin-top: 20px; color: #27ae60;"><i class="fas fa-user"></i> Patients</h3>
        <div class="appointments-table">
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in patients %}
                    <tr>
                        <td>
                            <div class="patient-cell">
                                <strong>{{ user.username }}</strong>
                            </div>
                        </td>
                        <td>
                            <div class="patient-cell">
                                <small>{{ user.email or 'N/A' }}</small>
                                <small>{{ user.phone or 'N/A' }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm btn-primary" onclick="openEditUser(this)"
                                    data-username="{{ user.username }}" data-email="{{ user.email }}"
                                    data-phone="{{ user.phone }}" data-role="{{ user.role }}">
                                    Edit
                                </button>
                                <button class="btn-sm btn-danger" onclick="deleteUser('{{ user.username }}')">
                                    Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        {% else %}
        <div class="no-data">
            <i class="fas fa-users"></i>
            <p>No users available</p>
        </div>
        {% endif %}
    </div>

    <!-- Recent Appointments (Upcoming) -->
    <div class="recent-section">
        <div class="section-header">
            <h2><i class="fas fa-calendar-alt"></i> Upcoming Appointments</h2>
        </div>

        {% if recent_appointments %}
        <div class="appointments-table">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Patient</th>
                        <th>Doctor</th>
                        <th>Date & Time</th>
                        <th>Symptoms</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for appointment in recent_appointments %}
                    <tr>
                        <td>#{{ appointment.id }}</td>
                        <td>
                            <div class="patient-cell">
                                <strong>{{ appointment.patient.username }}</strong>
                                <small>{{ appointment.patient.email or 'N/A' }}</small>
                            </div>
                        </td>
                        <td>{{ appointment.doctor.name }}</td>
                        <td>
                            <div class="datetime-cell">
                                <span class="date">{{ appointment.appointment_date.strftime('%b %d, %Y') }}</span>
                                <span class="time">{{ appointment.appointment_time }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="symptoms-text">{{ appointment.symptoms[:50] }}{% if appointment.symptoms|length
                                > 50 %}...{% endif %}</span>
                        </td>
                        <td>
                            <span class="status-badge {{ appointment.status }}">
                                {{ 'Approved' if appointment.status == 'confirmed' else appointment.status|title }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if appointment.status == 'pending' %}
                                <button class="btn-sm btn-success"
                                    onclick="updateAppointment('{{ appointment.id }}', 'confirmed')">
                                    Confirm
                                </button>
                                <button class="btn-sm btn-danger"
                                    onclick="updateAppointment('{{ appointment.id }}', 'cancelled')">
                                    Cancel
                                </button>
                                {% endif %}
                                <button class="btn-sm btn-info" onclick="viewDetails('{{ appointment.id }}')">
                                    Details
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                </< /table>
        </div>
        {% else %}
        <div class="no-data">
            <i class="fas fa-calendar-times"></i>
            <p>No upcoming appointments</p>
        </div>
        {% endif %}
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-section">
                        <h4>User Information</h4>
                        <div class="form-group">
                            <label for="user_username">Username <span class="required">*</span></label>
                            <input type="text" id="user_username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="user_password">Password <span class="required">*</span></label>
                            <input type="password" id="user_password" name="password" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="user_email">Email</label>
                                <input type="email" id="user_email" name="email">
                            </div>
                            <div class="form-group">
                                <label for="user_phone">Phone</label>
                                <input type="tel" id="user_phone" name="phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="user_role">Role <span class="required">*</span></label>
                            <select id="user_role" name="role" required>
                                <option value="user">Patient</option>
                                <option value="doctor">Doctor</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="edit_user_username" name="username">
                    <div class="form-section">
                        <h4>User Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_user_email">Email</label>
                                <input type="email" id="edit_user_email" name="email">
                            </div>
                            <div class="form-group">
                                <label for="edit_user_phone">Phone</label>
                                <input type="tel" id="edit_user_phone" name="phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit_user_role">Role</label>
                            <select id="edit_user_role" name="role">
                                <option value="user">Patient</option>
                                <option value="doctor">Doctor</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit_user_password">New Password (leave blank to keep current)</label>
                            <input type="password" id="edit_user_password" name="password">
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Doctor Modal -->
    <div id="addDoctorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Doctor</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addDoctorForm">
                    <!-- Login Credentials -->
                    <div class="form-section">
                        <h4>Login Credentials</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">Username <span class="required">*</span></label>
                                <input type="text" id="username" name="username" placeholder="doctor_username" required
                                    minlength="3">
                                <small class="form-help">Used for login (minimum 3 characters)</small>
                            </div>
                            <div class="form-group">
                                <label for="password">Temporary Password <span class="required">*</span></label>
                                <input type="password" id="password" name="password" placeholder="Enter password"
                                    required minlength="6">
                                <small class="form-help">Doctor can change this later (minimum 6 characters)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information -->
                    <div class="form-section">
                        <h4>Personal Information</h4>
                        <div class="form-group">
                            <label for="doctor_name">Full Name <span class="required">*</span></label>
                            <input type="text" id="doctor_name" name="name" placeholder="Dr. John Doe" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email <span class="required">*</span></label>
                                <input type="email" id="email" name="email" placeholder="doctor@example.com" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone <span class="required">*</span></label>
                                <input type="tel" id="phone" name="phone" placeholder="+1 234 567 8900" required>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Details -->
                    <div class="form-section">
                        <h4>Professional Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="specialization">Specialization <span class="required">*</span></label>
                                <input type="text" id="specialization" name="specialization" placeholder="Cardiology"
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="qualifications">Qualifications <span class="required">*</span></label>
                                <input type="text" id="qualifications" name="qualifications" placeholder="MBBS, MD"
                                    required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="experience">Experience (Years) <span class="required">*</span></label>
                                <input type="number" id="experience" name="experience" min="0" placeholder="5" required>
                            </div>
                            <div class="form-group">
                                <label for="consultation_fee">Consultation Fee ($) <span
                                        class="required">*</span></label>
                                <input type="number" step="0.01" id="consultation_fee" name="consultation_fee" min="0"
                                    placeholder="50.00" required>
                            </div>
                        </div>
                    </div>

                    <!-- Availability -->
                    <div class="form-section">
                        <h4>Availability</h4>
                        <div class="form-group">
                            <label for="available_days">Available Days <span class="required">*</span></label>
                            <input type="text" id="available_days" name="available_days"
                                placeholder="Monday, Wednesday, Friday" required>
                            <small class="form-help">Enter days separated by commas</small>
                        </div>

                        <div class="form-group">
                            <label for="available_time">Available Time <span class="required">*</span></label>
                            <input type="text" id="available_time" name="available_time" placeholder="9:00 AM - 5:00 PM"
                                required>
                            <small class="form-help">Enter available time range</small>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Doctor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Doctor Modal -->
    <div id="editDoctorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Doctor</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editDoctorForm">
                    <input type="hidden" id="edit_doctor_id" name="doctor_id">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h4>Personal Information</h4>
                        <div class="form-group">
                            <label for="edit_doctor_name">Full Name <span class="required">*</span></label>
                            <input type="text" id="edit_doctor_name" name="name" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_email">Email <span class="required">*</span></label>
                                <input type="email" id="edit_email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_phone">Phone <span class="required">*</span></label>
                                <input type="tel" id="edit_phone" name="phone" required>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Details -->
                    <div class="form-section">
                        <h4>Professional Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_specialization">Specialization <span class="required">*</span></label>
                                <input type="text" id="edit_specialization" name="specialization" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_qualifications">Qualifications <span class="required">*</span></label>
                                <input type="text" id="edit_qualifications" name="qualifications" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_experience">Experience (Years) <span class="required">*</span></label>
                                <input type="number" id="edit_experience" name="experience" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_consultation_fee">Consultation Fee ($) <span
                                        class="required">*</span></label>
                                <input type="number" step="0.01" id="edit_consultation_fee" name="consultation_fee"
                                    min="0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Availability -->
                    <div class="form-section">
                        <h4>Availability</h4>
                        <div class="form-group">
                            <label for="edit_available_days">Available Days <span class="required">*</span></label>
                            <input type="text" id="edit_available_days" name="available_days" required>
                            <small class="form-help">Enter days separated by commas</small>
                        </div>

                        <div class="form-group">
                            <label for="edit_available_time">Available Time <span class="required">*</span></label>
                            <input type="text" id="edit_available_time" name="available_time" required>
                            <small class="form-help">Enter available time range</small>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Appointment Details Modal -->
    <div id="appointmentDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Appointment Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>Appointment Information</h4>
                    <div class="summary-row">
                        <span>Appointment ID</span>
                        <strong id="detailId">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Patient Name</span>
                        <strong id="detailPatient">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Doctor Name</span>
                        <strong id="detailDoctor">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Date</span>
                        <strong id="detailDate">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Time</span>
                        <strong id="detailTime">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Status</span>
                        <strong id="detailStatus">-</strong>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary close-modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reports</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>Current Metrics</h4>
                    <div class="summary-row">
                        <span>Total Patients</span>
                        <strong>{{ total_patients }}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Active Doctors</span>
                        <strong>{{ total_doctors }}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Total Appointments</span>
                        <strong>{{ total_appointments }}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Pending Approvals</span>
                        <strong>{{ pending_appointments }}</strong>
                    </div>
                </div>
                <div class="form-section">
                    <h4>Export</h4>
                    <p>Download appointment data for external analysis.</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary close-modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>System Settings</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>Platform</h4>
                    <div class="form-group">
                        <label>Maintenance Mode</label>
                        <div class="terms">
                            <input type="checkbox" disabled>
                            <span>Coming soon â€” manage downtime announcements</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notifications</label>
                        <div class="terms">
                            <input type="checkbox" checked disabled>
                            <span>Email confirmations enabled</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h4>Data & Privacy</h4>
                    <p>Use admin tools to update settings. This panel is for quick visibility; saving changes will be
                        added later.</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary close-modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Upload Admin Profile Picture
    function uploadAdminProfilePicture() {
        const fileInput = document.getElementById('adminProfilePictureInput');
        if (!fileInput.files.length) return;

        const formData = new FormData();
        formData.append('profile_picture', fileInput.files[0]);

        fetch('/upload-profile-picture', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Profile picture updated successfully');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Upload failed. Please try again.');
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Modal functionality (supports multiple modals)
        const modals = document.querySelectorAll('.modal');
        const addDoctorBtn = document.querySelector('[data-action="add-doctor"]');
        const reportsBtn = document.querySelector('[data-action="view-reports"]');
        const settingsBtn = document.querySelector('[data-action="system-settings"]');
        const closeBtns = document.querySelectorAll('.close-modal');
        const editDoctorForm = document.getElementById('editDoctorForm');

        const openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }
        };

        const closeModal = (modal) => {
            modal.style.display = 'none';
            modal.classList.remove('active');
        };

        addDoctorBtn?.addEventListener('click', () => openModal('addDoctorModal'));
        reportsBtn?.addEventListener('click', () => openModal('reportsModal'));
        settingsBtn?.addEventListener('click', () => openModal('settingsModal'));

        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                modals.forEach(modal => closeModal(modal));
            });
        });

        window.addEventListener('click', (e) => {
            modals.forEach(modal => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });

        // Edit Doctor Form submit
        if (editDoctorForm) {
            editDoctorForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const doctorId = document.getElementById('edit_doctor_id').value;
                const formData = new FormData(this);

                fetch(`/admin/update-doctor/${doctorId}`, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Doctor updated successfully!');
                            closeModal(document.getElementById('editDoctorModal'));
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });
            });
        }

        // Add Doctor Form
        const addDoctorForm = document.getElementById('addDoctorForm');
        addDoctorForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch('{{ url_for("add_doctor") }}', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Doctor added successfully!');
                        closeModal(document.getElementById('addDoctorModal'));
                        location.reload(); // Reload to show new doctor
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
        });

        // ===== USER MANAGEMENT =====
        const addUserBtn = document.querySelector('[data-action="add-user"]');
        const addUserForm = document.getElementById('addUserForm');
        const editUserForm = document.getElementById('editUserForm');

        addUserBtn?.addEventListener('click', () => openModal('addUserModal'));

        // Add User Form
        if (addUserForm) {
            addUserForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                fetch('/admin/add-user', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('User created successfully!');
                            closeModal(document.getElementById('addUserModal'));
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });
            });
        }

        // Edit User Form
        if (editUserForm) {
            editUserForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const username = document.getElementById('edit_user_username').value;
                const formData = new FormData(this);

                fetch(`/admin/update-user/${username}`, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('User updated successfully!');
                            closeModal(document.getElementById('editUserModal'));
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });
            });
        }
    });

    // Update appointment status
    function updateAppointment(appointmentId, status) {
        if (!confirm(`Are you sure you want to ${status} this appointment?`)) {
            return;
        }

        console.log(`Updating appointment ${appointmentId} to status ${status}`);

        const formData = new FormData();
        formData.append('status', status);

        fetch(`/admin/update-appointment/${appointmentId}`, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    alert('Appointment updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }

    // Delete doctor
    function deleteDoctor(doctorId) {
        if (!confirm('Remove this doctor? This cannot be undone.')) {
            return;
        }

        fetch(`/admin/delete-doctor/${doctorId}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || 'Doctor removed successfully');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }

    // Open edit doctor modal and populate fields
    function openEditDoctor(button) {
        const modal = document.getElementById('editDoctorModal');
        if (!modal) return;

        document.getElementById('edit_doctor_id').value = button.dataset.id || '';
        document.getElementById('edit_doctor_name').value = button.dataset.name || '';
        document.getElementById('edit_specialization').value = button.dataset.specialization || '';
        document.getElementById('edit_qualifications').value = button.dataset.qualifications || '';
        document.getElementById('edit_experience').value = button.dataset.experience || '';
        document.getElementById('edit_email').value = button.dataset.email || '';
        document.getElementById('edit_phone').value = button.dataset.phone || '';
        document.getElementById('edit_consultation_fee').value = button.dataset.fee || '';
        document.getElementById('edit_available_days').value = button.dataset.days || '';
        document.getElementById('edit_available_time').value = button.dataset.time || '';

        modal.style.display = 'flex';
        modal.classList.add('active');
    }

    // View appointment details
    function viewDetails(appointmentId) {
        console.log(`Opening details for appointment: ${appointmentId}`);

        // Find the appointment row in the table
        const rows = document.querySelectorAll('.appointments-table tbody tr');
        let appointmentData = null;

        rows.forEach(row => {
            const firstCell = row.querySelector('td');
            if (firstCell && firstCell.textContent.includes(appointmentId)) {
                const cells = row.querySelectorAll('td');
                // Updated cell indices to match new table structure
                // ID, Patient, Doctor, DateTime, Symptoms, Status, Actions
                const patientCell = cells[1].querySelectorAll('*');
                const patientName = patientCell.length > 0 ? patientCell[0].textContent.trim() : cells[1].textContent.trim();

                const dateTimeCell = cells[3];
                const dateElements = dateTimeCell.querySelectorAll('span');
                const date = dateElements.length > 0 ? dateElements[0].textContent.trim() : cells[3].textContent.split('\n')[0].trim();
                const time = dateElements.length > 1 ? dateElements[1].textContent.trim() : cells[3].textContent.split('\n')[1]?.trim() || '-';
                const symptoms = cells[4] ? cells[4].textContent.trim() : '-';

                appointmentData = {
                    id: appointmentId,
                    patient: patientName,
                    doctor: cells[2].textContent.trim(),
                    date: date,
                    time: time,
                    symptoms: symptoms,
                    status: cells[5].textContent.trim()
                };
            }
        });

        if (appointmentData) {
            console.log('Appointment data found:', appointmentData);
            // Populate modal fields
            document.getElementById('detailId').textContent = appointmentData.id;
            document.getElementById('detailPatient').textContent = appointmentData.patient;
            document.getElementById('detailDoctor').textContent = appointmentData.doctor;
            document.getElementById('detailDate').textContent = appointmentData.date;
            document.getElementById('detailTime').textContent = appointmentData.time;
            document.getElementById('detailStatus').textContent = appointmentData.status;

            // Open modal
            const modal = document.getElementById('appointmentDetailsModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }
        } else {
            console.error('Appointment not found:', appointmentId);
            alert('Could not find appointment details');
        }
    }

    // ===== USER MANAGEMENT FUNCTIONS =====
    function openEditUser(button) {
        const modal = document.getElementById('editUserModal');
        if (!modal) return;

        document.getElementById('edit_user_username').value = button.dataset.username || '';
        document.getElementById('edit_user_email').value = button.dataset.email || '';
        document.getElementById('edit_user_phone').value = button.dataset.phone || '';
        document.getElementById('edit_user_role').value = button.dataset.role || 'user';
        document.getElementById('edit_user_password').value = ''; // Clear password field

        modal.style.display = 'flex';
        modal.classList.add('active');
    }

    function deleteUser(username) {
        if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
            return;
        }

        fetch(`/admin/delete-user/${username}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || 'User deleted successfully');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
</script>
{% endblock %}