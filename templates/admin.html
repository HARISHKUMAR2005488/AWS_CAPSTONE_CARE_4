{% extends "base.html" %}

{% block title %}Admin Dashboard - Care_4_U Hospitals{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1>Admin Dashboard</h1>
        <p class="welcome-message">Welcome back, {{ current_user.username }}!</p>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon patients">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_patients }}</h3>
                <p>Total Patients</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon doctors">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_doctors }}</h3>
                <p>Active Doctors</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon appointments">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_appointments }}</h3>
                <p>Total Appointments</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon pending">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>{{ pending_appointments }}</h3>
                <p>Pending Approvals</p>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
            <button class="action-btn" data-action="add-doctor">
                <i class="fas fa-user-plus"></i>
                <span>Add New Doctor</span>
            </button>
            <button class="action-btn" data-action="view-reports">
                <i class="fas fa-chart-bar"></i>
                <span>View Reports</span>
            </button>
            <button class="action-btn" data-action="system-settings">
                <i class="fas fa-cog"></i>
                <span>System Settings</span>
            </button>
        </div>
    </div>

    <!-- Doctors List -->
    <div class="recent-section">
        <div class="section-header">
            <h2>Doctors</h2>
        </div>
        
        {% if doctors %}
            <div class="appointments-table">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Specialization</th>
                            <th>Contact</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doctor in doctors %}
                            <tr>
                                <td>
                                    <div class="patient-cell">
                                        <strong>{{ doctor.name }}</strong>
                                        <small>{{ doctor.qualifications }}</small>
                                    </div>
                                </td>
                                <td>{{ doctor.specialization }}</td>
                                <td>
                                    <div class="patient-cell">
                                        <small>{{ doctor.email }}</small>
                                        <small>{{ doctor.phone }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="datetime-cell">
                                        <span class="date">{{ doctor.available_days }}</span>
                                        <span class="time">{{ doctor.available_time }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-sm btn-primary"
                                                onclick="openEditDoctor(this)"
                                                data-id="{{ doctor.id }}"
                                                data-name="{{ doctor.name }}"
                                                data-specialization="{{ doctor.specialization }}"
                                                data-qualifications="{{ doctor.qualifications }}"
                                                data-experience="{{ doctor.experience }}"
                                                data-email="{{ doctor.email }}"
                                                data-phone="{{ doctor.phone }}"
                                                data-fee="{{ doctor.consultation_fee }}"
                                                data-days="{{ doctor.available_days }}"
                                                data-time="{{ doctor.available_time }}">
                                            Edit
                                        </button>
                                        <button class="btn-sm btn-danger" onclick="deleteDoctor({{ doctor.id }})">
                                            Remove
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="no-data">
                <i class="fas fa-user-md"></i>
                <p>No doctors available</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Recent Appointments -->
    <div class="recent-section">
        <div class="section-header">
            <h2>Recent Appointments</h2>
        </div>
        
        {% if recent_appointments %}
            <div class="appointments-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Patient</th>
                            <th>Doctor</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in recent_appointments %}
                            <tr>
                                <td>#{{ appointment.id }}</td>
                                <td>{{ appointment.patient.username }}</td>
                                <td>{{ appointment.doctor.name }}</td>
                                <td>
                                    {{ appointment.appointment_date.strftime('%b %d, %Y') }}
                                    <br>
                                    <small>{{ appointment.appointment_time }}</small>
                                </td>
                                <td>
                                    <span class="status-badge {{ appointment.status }}">
                                        {{ appointment.status|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        {% if appointment.status == 'pending' %}
                                            <button class="btn-sm btn-success" 
                                                    onclick="updateAppointment({{ appointment.id }}, 'confirmed')">
                                                Confirm
                                            </button>
                                            <button class="btn-sm btn-danger"
                                                    onclick="updateAppointment({{ appointment.id }}, 'cancelled')">
                                                Cancel
                                            </button>
                                        {% endif %}
                                        <button class="btn-sm btn-info" onclick="viewDetails({{ appointment.id }})">
                                            Details
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="no-data">
                <i class="fas fa-calendar-times"></i>
                <p>No appointments found</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Add Doctor Modal -->
    <div id="addDoctorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Doctor</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addDoctorForm">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h4>Personal Information</h4>
                        <div class="form-group">
                            <label for="doctor_name">Full Name <span class="required">*</span></label>
                            <input type="text" id="doctor_name" name="name" placeholder="Dr. John Doe" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email <span class="required">*</span></label>
                                <input type="email" id="email" name="email" placeholder="doctor@example.com" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone <span class="required">*</span></label>
                                <input type="tel" id="phone" name="phone" placeholder="+1 234 567 8900" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Professional Details -->
                    <div class="form-section">
                        <h4>Professional Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="specialization">Specialization <span class="required">*</span></label>
                                <input type="text" id="specialization" name="specialization" placeholder="Cardiology" required>
                            </div>
                            <div class="form-group">
                                <label for="qualifications">Qualifications <span class="required">*</span></label>
                                <input type="text" id="qualifications" name="qualifications" placeholder="MBBS, MD" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="experience">Experience (Years) <span class="required">*</span></label>
                                <input type="number" id="experience" name="experience" min="0" placeholder="5" required>
                            </div>
                            <div class="form-group">
                                <label for="consultation_fee">Consultation Fee ($) <span class="required">*</span></label>
                                <input type="number" step="0.01" id="consultation_fee" name="consultation_fee" min="0" placeholder="50.00" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Availability -->
                    <div class="form-section">
                        <h4>Availability</h4>
                        <div class="form-group">
                            <label for="available_days">Available Days <span class="required">*</span></label>
                            <input type="text" id="available_days" name="available_days" 
                                   placeholder="Monday, Wednesday, Friday" required>
                            <small class="form-help">Enter days separated by commas</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="available_time">Available Time <span class="required">*</span></label>
                            <input type="text" id="available_time" name="available_time" 
                                   placeholder="9:00 AM - 5:00 PM" required>
                            <small class="form-help">Enter available time range</small>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Doctor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Doctor Modal -->
    <div id="editDoctorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Doctor</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editDoctorForm">
                    <input type="hidden" id="edit_doctor_id" name="doctor_id">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h4>Personal Information</h4>
                        <div class="form-group">
                            <label for="edit_doctor_name">Full Name <span class="required">*</span></label>
                            <input type="text" id="edit_doctor_name" name="name" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_email">Email <span class="required">*</span></label>
                                <input type="email" id="edit_email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_phone">Phone <span class="required">*</span></label>
                                <input type="tel" id="edit_phone" name="phone" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Professional Details -->
                    <div class="form-section">
                        <h4>Professional Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_specialization">Specialization <span class="required">*</span></label>
                                <input type="text" id="edit_specialization" name="specialization" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_qualifications">Qualifications <span class="required">*</span></label>
                                <input type="text" id="edit_qualifications" name="qualifications" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_experience">Experience (Years) <span class="required">*</span></label>
                                <input type="number" id="edit_experience" name="experience" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_consultation_fee">Consultation Fee ($) <span class="required">*</span></label>
                                <input type="number" step="0.01" id="edit_consultation_fee" name="consultation_fee" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Availability -->
                    <div class="form-section">
                        <h4>Availability</h4>
                        <div class="form-group">
                            <label for="edit_available_days">Available Days <span class="required">*</span></label>
                            <input type="text" id="edit_available_days" name="available_days" required>
                            <small class="form-help">Enter days separated by commas</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_available_time">Available Time <span class="required">*</span></label>
                            <input type="text" id="edit_available_time" name="available_time" required>
                            <small class="form-help">Enter available time range</small>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Appointment Details Modal -->
    <div id="appointmentDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Appointment Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>Appointment Information</h4>
                    <div class="summary-row">
                        <span>Appointment ID</span>
                        <strong id="detailId">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Patient Name</span>
                        <strong id="detailPatient">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Doctor Name</span>
                        <strong id="detailDoctor">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Date</span>
                        <strong id="detailDate">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Time</span>
                        <strong id="detailTime">-</strong>
                    </div>
                    <div class="summary-row">
                        <span>Status</span>
                        <strong id="detailStatus">-</strong>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary close-modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reports</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>Current Metrics</h4>
                    <div class="summary-row">
                        <span>Total Patients</span>
                        <strong>{{ total_patients }}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Active Doctors</span>
                        <strong>{{ total_doctors }}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Total Appointments</span>
                        <strong>{{ total_appointments }}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Pending Approvals</span>
                        <strong>{{ pending_appointments }}</strong>
                    </div>
                </div>
                <div class="form-section">
                    <h4>Export</h4>
                    <p>Download appointment data for external analysis.</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary close-modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>System Settings</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>Platform</h4>
                    <div class="form-group">
                        <label>Maintenance Mode</label>
                        <div class="terms">
                            <input type="checkbox" disabled>
                            <span>Coming soon â€” manage downtime announcements</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notifications</label>
                        <div class="terms">
                            <input type="checkbox" checked disabled>
                            <span>Email confirmations enabled</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h4>Data & Privacy</h4>
                    <p>Use admin tools to update settings. This panel is for quick visibility; saving changes will be added later.</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary close-modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modal functionality (supports multiple modals)
    const modals = document.querySelectorAll('.modal');
    const addDoctorBtn = document.querySelector('[data-action="add-doctor"]');
    const reportsBtn = document.querySelector('[data-action="view-reports"]');
    const settingsBtn = document.querySelector('[data-action="system-settings"]');
    const closeBtns = document.querySelectorAll('.close-modal');
    const editDoctorForm = document.getElementById('editDoctorForm');

    const openModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            modal.classList.add('active');
        }
    };

    const closeModal = (modal) => {
        modal.style.display = 'none';
        modal.classList.remove('active');
    };

    addDoctorBtn?.addEventListener('click', () => openModal('addDoctorModal'));
    reportsBtn?.addEventListener('click', () => openModal('reportsModal'));
    settingsBtn?.addEventListener('click', () => openModal('settingsModal'));
    
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            modals.forEach(modal => closeModal(modal));
        });
    });
    
    window.addEventListener('click', (e) => {
        modals.forEach(modal => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });

    // Edit Doctor Form submit
    if (editDoctorForm) {
        editDoctorForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const doctorId = document.getElementById('edit_doctor_id').value;
            const formData = new FormData(this);

            fetch(`/admin/update-doctor/${doctorId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Doctor updated successfully!');
                    closeModal(document.getElementById('editDoctorModal'));
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }
    
    // Add Doctor Form
    const addDoctorForm = document.getElementById('addDoctorForm');
    addDoctorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{{ url_for("add_doctor") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Doctor added successfully!');
                closeModal(document.getElementById('addDoctorModal'));
                location.reload(); // Reload to show new doctor
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });
});

// Update appointment status
function updateAppointment(appointmentId, status) {
    if (!confirm(`Are you sure you want to ${status} this appointment?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('status', status);
    
    fetch(`/admin/update-appointment/${appointmentId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Delete doctor
function deleteDoctor(doctorId) {
    if (!confirm('Remove this doctor? This cannot be undone.')) {
        return;
    }

    fetch(`/admin/delete-doctor/${doctorId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'Doctor removed successfully');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Open edit doctor modal and populate fields
function openEditDoctor(button) {
    const modal = document.getElementById('editDoctorModal');
    if (!modal) return;

    document.getElementById('edit_doctor_id').value = button.dataset.id || '';
    document.getElementById('edit_doctor_name').value = button.dataset.name || '';
    document.getElementById('edit_specialization').value = button.dataset.specialization || '';
    document.getElementById('edit_qualifications').value = button.dataset.qualifications || '';
    document.getElementById('edit_experience').value = button.dataset.experience || '';
    document.getElementById('edit_email').value = button.dataset.email || '';
    document.getElementById('edit_phone').value = button.dataset.phone || '';
    document.getElementById('edit_consultation_fee').value = button.dataset.fee || '';
    document.getElementById('edit_available_days').value = button.dataset.days || '';
    document.getElementById('edit_available_time').value = button.dataset.time || '';

    modal.style.display = 'flex';
    modal.classList.add('active');
}

// View appointment details
function viewDetails(appointmentId) {
    // Find the appointment row in the table
    const rows = document.querySelectorAll('.appointments-table tbody tr');
    let appointmentData = null;
    
    rows.forEach(row => {
        if (row.textContent.includes(`#${appointmentId}`)) {
            const cells = row.querySelectorAll('td');
            appointmentData = {
                id: cells[0].textContent.trim(),
                patient: cells[1].textContent.trim(),
                doctor: cells[2].textContent.trim(),
                dateTime: cells[3].textContent.trim(),
                status: cells[4].textContent.trim()
            };
        }
    });
    
    if (appointmentData) {
        // Extract date and time
        const dateTimeParts = appointmentData.dateTime.split('\n').map(p => p.trim());
        const date = dateTimeParts[0] || '-';
        const time = dateTimeParts[1] || '-';
        
        // Populate modal fields
        document.getElementById('detailId').textContent = appointmentData.id;
        document.getElementById('detailPatient').textContent = appointmentData.patient;
        document.getElementById('detailDoctor').textContent = appointmentData.doctor;
        document.getElementById('detailDate').textContent = date;
        document.getElementById('detailTime').textContent = time;
        document.getElementById('detailStatus').textContent = appointmentData.status;
        
        // Open modal
        const modal = document.getElementById('appointmentDetailsModal');
        modal.style.display = 'flex';
        modal.classList.add('active');
    }
}
</script>
{% endblock %}