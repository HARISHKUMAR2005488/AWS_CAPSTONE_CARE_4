{% extends "base.html" %}

{% block title %}Doctor Dashboard - Care_4_U Hospitals{% endblock %}

{% block content %}
<div class="doctor-container">
    <!-- Top Header -->
    <div class="doctor-header">
        <div class="header-left">
            <div class="logo-section">
                <i class="fas fa-heart"></i>
                <span>Care_4_U Hospitals</span>
            </div>
            <h1>Doctor Dashboard</h1>
        </div>
        <div class="header-right">
            <div class="doctor-info-header">
                <div class="doctor-avatar-header">
                    {% if doctor.profile_image %}
                        <img src="{{ url_for('serve_profile_picture', filename=doctor.profile_image.split('/')[-1]) }}" alt="{{ doctor.name }}">
                    {% else %}
                        <i class="fas fa-user-md"></i>
                    {% endif %}
                </div>
                <div class="doctor-details-header">
                    <h3>{{ doctor.name }}</h3>
                    <p>{{ doctor.specialization }}</p>
                </div>
            </div>
            <button class="btn-logout" onclick="location.href='{{ url_for('logout') }}'">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="doctor-dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="doctor-sidebar">
            <nav class="doctor-nav">
                <a href="#" class="nav-item active" onclick="showDashboardView(event)">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" onclick="showTodayView(event)">
                    <i class="fas fa-calendar-day"></i>
                    <span>Today's Appointments</span>
                </a>
                <a href="{{ url_for('doctor_patients') }}" class="nav-item">
                    <i class="fas fa-user-injured"></i>
                    <span>Patient Records</span>
                </a>
                <a href="#" class="nav-item" onclick="showRequestsView(event)">
                    <i class="fas fa-clock"></i>
                    <span>Appointment Requests</span>
                </a>
                <a href="#" class="nav-item" onclick="showScheduleView(event)">
                    <i class="fas fa-calendar-alt"></i>
                    <span>My Schedule</span>
                </a>
                <a href="#" class="nav-item" onclick="showSettingsView(event)">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="doctor-main-content">
            <!-- Dashboard View -->
            <div class="content-view dashboard-view" id="dashboardView">
                <!-- Overview Cards -->
                <div class="overview-grid">
                    <div class="overview-card">
                        <div class="card-icon appointments-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ total_appointments }}</h3>
                            <p>Appointments Today</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon pending-icon">
                            <i class="fas fa-hourglass-start"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ pending_count }}</h3>
                            <p>Pending Requests</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon completed-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ completed_count }}</h3>
                            <p>Completed Today</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon available-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ confirmed_count }}</h3>
                            <p>Confirmed Slots</p>
                        </div>
                    </div>
                </div>

                <!-- Doctor Profile Quick View -->
                <div class="doctor-profile-quick">
                    <div class="profile-quick-header">
                        <h2><i class="fas fa-user-md"></i> Your Profile</h2>
                    </div>
                    <div class="profile-quick-content">
                        <div class="profile-quick-avatar">
                            {% if doctor.profile_image %}
                                <img src="{{ url_for('serve_profile_picture', filename=doctor.profile_image.split('/')[-1]) }}" alt="{{ doctor.name }}">
                            {% else %}
                                <i class="fas fa-user-md"></i>
                            {% endif %}
                        </div>
                        <div class="profile-quick-info">
                            <h3>{{ doctor.name }}</h3>
                            <p class="specialization">{{ doctor.specialization }}</p>
                            <p class="experience"><i class="fas fa-award"></i> {{ doctor.experience }} years experience</p>
                            <div class="profile-quick-actions">
                                <button class="btn-text" onclick="showSettingsView(event)">
                                    <i class="fas fa-edit"></i> Edit Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Appointments Preview -->
                <div class="appointments-preview">
                    <div class="section-header">
                        <h2><i class="fas fa-calendar-day"></i> Next Appointments</h2>
                        <a href="#" class="view-all-link" onclick="showTodayView(event)">View All →</a>
                    </div>
                    {% if today_appointments %}
                        <div class="appointments-list">
                            {% for appointment in today_appointments[:3] %}
                                <div class="appointment-item">
                                    <div class="appointment-time-badge">
                                        <span class="time">{{ appointment.appointment_time }}</span>
                                    </div>
                                    <div class="appointment-info">
                                        <h4>{{ appointment.patient.username }}</h4>
                                        <p>{{ appointment.symptoms[:50] }}{% if appointment.symptoms|length > 50 %}...{% endif %}</p>
                                    </div>
                                    <span class="status-badge-mini status-{{ appointment.status|lower }}">
                                        {{ appointment.status|title }}
                                    </span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No appointments today</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Appointment Requests Summary -->
                <div class="requests-summary">
                    <div class="section-header">
                        <h2><i class="fas fa-bell"></i> Pending Requests</h2>
                        <a href="#" class="view-all-link" onclick="showRequestsView(event)">View All →</a>
                    </div>
                    <div class="request-summary-content">
                        <div class="request-stat">
                            <div class="stat-number">{{ pending_count }}</div>
                            <p>Awaiting Your Approval</p>
                        </div>
                        <button class="btn btn-primary" onclick="showRequestsView(event)">
                            <i class="fas fa-list-check"></i> Review Requests
                        </button>
                    </div>
                </div>
            </div>

            <!-- Today's Appointments View -->
            <div class="content-view today-view" id="todayView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-day"></i> Today's Appointments</h2>
                    <p class="date-display">{{ today.strftime('%A, %B %d, %Y') }}</p>
                </div>
                {% if today_appointments %}
                    <div class="appointments-table-container">
                        <div class="appointments-cards">
                            {% for appointment in today_appointments %}
                                <div class="appointment-card-detailed {{ appointment.status|lower }}">
                                    <div class="card-header">
                                        <div class="patient-section">
                                            <h3>{{ appointment.patient.username }}</h3>
                                            <p class="email">{{ appointment.patient.email }}</p>
                                        </div>
                                        <span class="status-badge status-{{ appointment.status|lower }}">
                                            {{ 'Approved' if appointment.status == 'confirmed' else appointment.status|title }}
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="appointment-detail">
                                            <i class="fas fa-clock"></i>
                                            <span>{{ appointment.appointment_time }}</span>
                                        </div>
                                        {% if appointment.symptoms %}
                                            <div class="appointment-detail">
                                                <i class="fas fa-notes-medical"></i>
                                                <span>{{ appointment.symptoms }}</span>
                                            </div>
                                        {% endif %}
                                        {% if appointment.notes %}
                                            <div class="appointment-detail">
                                                <i class="fas fa-sticky-note"></i>
                                                <span>{{ appointment.notes }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn btn-outline btn-sm">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                        {% if appointment.status == 'pending' %}
                                            <button class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button class="btn btn-danger btn-sm">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        {% elif appointment.status == 'confirmed' %}
                                            <button class="btn btn-primary btn-sm">
                                                <i class="fas fa-video"></i> Start Consultation
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="empty-state large">
                        <i class="fas fa-calendar-check"></i>
                        <h3>No Appointments Today</h3>
                        <p>Enjoy your break! You have no scheduled appointments.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Appointment Requests View -->
            <div class="content-view requests-view" id="requestsView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-clock"></i> Appointment Requests</h2>
                    <p class="subtitle">Review and approve pending appointment requests</p>
                </div>
                {% if pending_count > 0 %}
                    <div class="requests-container">
                        {% for appointment in today_appointments %}
                            {% if appointment.status == 'pending' %}
                                <div class="request-card">
                                    <div class="request-header">
                                        <h3>{{ appointment.patient.username }}</h3>
                                        <span class="request-time">Requested: {{ appointment.appointment_date.strftime('%b %d') }} at {{ appointment.appointment_time }}</span>
                                    </div>
                                    <div class="request-body">
                                        <div class="reason">
                                            <label>Reason for Visit:</label>
                                            <p>{{ appointment.symptoms }}</p>
                                        </div>
                                        {% if appointment.notes %}
                                            <div class="notes">
                                                <label>Additional Notes:</label>
                                                <p>{{ appointment.notes }}</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="request-actions">
                                        <button class="btn btn-success">
                                            <i class="fas fa-check-circle"></i> Approve
                                        </button>
                                        <button class="btn btn-danger">
                                            <i class="fas fa-times-circle"></i> Reject
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state large">
                        <i class="fas fa-inbox"></i>
                        <h3>No Pending Requests</h3>
                        <p>All appointment requests have been processed.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Schedule View -->
            <div class="content-view schedule-view" id="scheduleView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-alt"></i> My Schedule</h2>
                    <button class="btn btn-primary" onclick="showEditScheduleModal()">
                        <i class="fas fa-edit"></i> Edit Availability
                    </button>
                </div>
                <div class="schedule-card">
                    <div class="schedule-info">
                        <div class="schedule-item">
                            <label><i class="fas fa-calendar"></i> Available Days</label>
                            <p>{{ doctor.available_days }}</p>
                        </div>
                        <div class="schedule-item">
                            <label><i class="fas fa-clock"></i> Available Hours</label>
                            <p>{{ doctor.available_time }}</p>
                        </div>
                        <div class="schedule-item">
                            <label><i class="fas fa-dollar-sign"></i> Consultation Fee</label>
                            <p>${{ "%.2f"|format(doctor.consultation_fee) }}</p>
                        </div>
                    </div>
                    <div class="schedule-preview">
                        <h3>Weekly Schedule</h3>
                        <div class="weekly-grid">
                            <div class="day-slot">
                                <span class="day">Mon</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Tue</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Wed</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Thu</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Fri</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Sat</span>
                                <span class="time">10:00-14:00</span>
                                <span class="status available">Available</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div class="content-view settings-view" id="settingsView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Profile Settings</h2>
                </div>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3><i class="fas fa-user"></i> Personal Information</h3>
                        <div class="settings-item">
                            <label>Full Name</label>
                            <p>{{ doctor.name }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Specialization</label>
                            <p>{{ doctor.specialization }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Qualifications</label>
                            <p>{{ doctor.qualifications }}</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditProfileModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-phone"></i> Contact Information</h3>
                        <div class="settings-item">
                            <label>Email</label>
                            <p>{{ doctor.email }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Phone</label>
                            <p>{{ doctor.phone }}</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditContactModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-lock"></i> Account Security</h3>
                        <div class="settings-item">
                            <label>Password</label>
                            <p>••••••••</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showChangePasswordModal()">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
function showDashboardView(event) {
    event.preventDefault();
    showView('dashboardView');
    setActiveNav(event.target.closest('.nav-item'));
}

function showTodayView(event) {
    event.preventDefault();
    showView('todayView');
    setActiveNav(document.querySelector('[onclick*="showTodayView"]'));
}

function showRequestsView(event) {
    event.preventDefault();
    showView('requestsView');
    setActiveNav(document.querySelector('[onclick*="showRequestsView"]'));
}

function showScheduleView(event) {
    event.preventDefault();
    showView('scheduleView');
    setActiveNav(document.querySelector('[onclick*="showScheduleView"]'));
}

function showSettingsView(event) {
    event.preventDefault();
    showView('settingsView');
    setActiveNav(document.querySelector('[onclick*="showSettingsView"]'));
}

function showView(viewId) {
    const views = document.querySelectorAll('.content-view');
    views.forEach(view => view.style.display = 'none');
    document.getElementById(viewId).style.display = 'block';
}

function setActiveNav(element) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (element) element.classList.add('active');
}

function showEditScheduleModal() {
    alert('Edit Schedule feature - UI representation only');
}

function showEditProfileModal() {
    alert('Edit Profile feature - UI representation only');
}

function showEditContactModal() {
    alert('Edit Contact feature - UI representation only');
}

function showChangePasswordModal() {
    alert('Change Password feature - UI representation only');
}
</script>
 
                                        onclick="updateAppointmentStatus('{{ appointment.id }}', 'confirmed')">
                                    <i class="fas fa-check"></i> Confirm
                                </button>
                                <button class="btn-sm btn-danger"
                                        onclick="updateAppointmentStatus('{{ appointment.id }}', 'cancelled')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            {% elif appointment.status == 'confirmed' %}
                                <button class="btn-sm btn-primary" 
                                        onclick="addPrescriptionToComplete('{{ appointment.id }}')">
                                    <i class="fas fa-prescription"></i> Add Prescription & Complete
                                </button>
                                <button class="btn-sm btn-danger"
                                        onclick="updateAppointmentStatus('{{ appointment.id }}', 'cancelled')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            {% elif appointment.status == 'completed' %}
                                <button class="btn-sm btn-warning"
                                        onclick="addPrescription('{{ appointment.id }}', '{{ appointment.status }}')">
                                    <i class="fas fa-prescription"></i> Add Prescription
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">
                <i class="fas fa-calendar-times"></i>
                <p>No appointments scheduled for today</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Upcoming Appointments -->
    <div class="appointments-section">
        <div class="section-header">
            <h2><i class="fas fa-calendar-alt"></i> Upcoming Appointments</h2>
        </div>
        
        {% if upcoming_appointments %}
            <div class="appointments-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Patient</th>
                            <th>Date & Time</th>
                            <th>Symptoms</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in upcoming_appointments %}
                            <tr>
                                <td>#{{ appointment.id }}</td>
                                <td>
                                    <div class="patient-cell">
                                        <strong>{{ appointment.patient.username }}</strong>
                                        <small>{{ appointment.patient.email }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="datetime-cell">
                                        <span class="date">{{ appointment.appointment_date.strftime('%b %d, %Y') }}</span>
                                        <span class="time">{{ appointment.appointment_time }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="symptoms-text">{{ appointment.symptoms[:50] }}{% if appointment.symptoms|length > 50 %}...{% endif %}</span>
                                </td>
                                <td>
                                    <span class="status-badge {{ appointment.status }}">
                                        {{ 'Approved' if appointment.status == 'confirmed' else appointment.status|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        {% if appointment.status == 'pending' %}
                                            <button class="btn-sm btn-success" 
                                                    onclick="updateAppointmentStatus('{{ appointment.id }}', 'confirmed')">
                                                Confirm
                                            </button>
                                            <button class="btn-sm btn-danger"
                                                    onclick="updateAppointmentStatus('{{ appointment.id }}', 'cancelled')">
                                                Cancel
                                            </button>
                                        {% elif appointment.status == 'confirmed' %}
                                            <button class="btn-sm btn-primary" 
                                                    onclick="addPrescriptionToComplete('{{ appointment.id }}')">
                                                Add Prescription & Complete
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="no-data">
                <i class="fas fa-calendar-times"></i>
                <p>No upcoming appointments</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Notes Modal -->
<div id="notesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Prescription</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="notesForm">
                <input type="hidden" id="appointment_id" name="appointment_id">
                <input type="hidden" id="appointment_status" name="appointment_status">
                <div class="form-group">
                    <label for="notes">Prescription / Notes</label>
                    <textarea id="notes" name="notes" rows="5" required 
                              placeholder="Enter prescription, diagnosis, or recommendations..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Prescription</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Upload Doctor Profile Picture
function uploadDoctorProfilePicture() {
    const fileInput = document.getElementById('doctorProfilePictureInput');
    if (!fileInput.files.length) return;
    
    const formData = new FormData();
    formData.append('profile_picture', fileInput.files[0]);
    
    fetch('/upload-profile-picture', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Profile picture updated successfully');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Upload failed. Please try again.');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Modal functionality
    const modal = document.getElementById('notesModal');
    const closeBtns = document.querySelectorAll('.close-modal');
    
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    });
    
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Notes Form
    const notesForm = document.getElementById('notesForm');
    notesForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const appointmentId = document.getElementById('appointment_id').value;
        const appointmentStatus = document.getElementById('appointment_status').value;
        const notes = document.getElementById('notes').value;
        const formData = new FormData();
        formData.append('status', appointmentStatus || 'confirmed');
        formData.append('notes', notes);
        
        fetch(`/doctor/update-appointment/${appointmentId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Notes saved successfully!');
                modal.style.display = 'none';
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });
});

// Update appointment status
function updateAppointmentStatus(appointmentId, status) {
    if (!confirm(`Are you sure you want to ${status} this appointment?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('status', status);
    
    fetch(`/doctor/update-appointment/${appointmentId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Complete appointment with notes
function completeAppointment(appointmentId) {
    alert('Please add prescription before completing the appointment.');
}

// Add prescription to complete appointment (mandatory)
function addPrescriptionToComplete(appointmentId) {
    document.getElementById('appointment_id').value = appointmentId;
    document.getElementById('appointment_status').value = 'completed';
    document.getElementById('notes').value = '';
    document.getElementById('notes').required = true;
    document.getElementById('notesModal').style.display = 'block';
}

// Add prescription / notes
function addPrescription(appointmentId, status) {
    document.getElementById('appointment_id').value = appointmentId;
    document.getElementById('appointment_status').value = status || 'confirmed';
    document.getElementById('notes').value = '';
    document.getElementById('notes').required = false;
    document.getElementById('notesModal').style.display = 'block';
}
</script>
{% endblock %}
