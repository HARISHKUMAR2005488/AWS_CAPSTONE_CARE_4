{% extends "base.html" %}

{% block title %}Doctor Dashboard - Care_4_U Hospitals{% endblock %}

{% block content %}
<style>
    /* Hide navbar and footer for doctor dashboard */
    .navbar, .footer, .flash-messages {
        display: none !important;
    }
    body {
        margin: 0;
        padding: 0;
    }
    main {
        padding: 0;
        margin: 0;
    }
</style>
<div class="doctor-container">
    <!-- Top Header -->
    <div class="doctor-header">
        <div class="header-left">
            <div class="logo-section">
                <i class="fas fa-heart"></i>
                <span>Care_4_U Hospitals</span>
            </div>
            <h1>Doctor Dashboard</h1>
        </div>
        <div class="header-right">
            <div class="doctor-info-header">
                <div class="doctor-avatar-header">
                    {% if doctor.profile_image %}
                        <img src="{{ url_for('serve_profile_picture', filename=doctor.profile_image.split('/')[-1]) }}" alt="{{ doctor.name }}">
                    {% else %}
                        <i class="fas fa-user-md"></i>
                    {% endif %}
                </div>
                <div class="doctor-details-header">
                    <h3>{{ doctor.name }}</h3>
                    <p>{{ doctor.specialization }}</p>
                </div>
            </div>
            <button class="btn-logout" onclick="location.href='{{ url_for('logout') }}'">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="doctor-dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="doctor-sidebar">
            <nav class="doctor-nav">
                <a href="#" class="nav-item active" onclick="showDashboardView(event)">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" onclick="showTodayView(event)">
                    <i class="fas fa-calendar-day"></i>
                    <span>Today's Appointments</span>
                </a>
                <a href="{{ url_for('doctor_patients') }}" class="nav-item">
                    <i class="fas fa-user-injured"></i>
                    <span>Patient Records</span>
                </a>
                <a href="#" class="nav-item" onclick="showRequestsView(event)">
                    <i class="fas fa-clock"></i>
                    <span>Appointment Requests</span>
                </a>
                <a href="#" class="nav-item" onclick="showScheduleView(event)">
                    <i class="fas fa-calendar-alt"></i>
                    <span>My Schedule</span>
                </a>
                <a href="#" class="nav-item" onclick="showSettingsView(event)">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="doctor-main-content">
            <!-- Dashboard View -->
            <div class="content-view dashboard-view" id="dashboardView">
                <!-- Overview Cards -->
                <div class="overview-grid">
                    <div class="overview-card">
                        <div class="card-icon appointments-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ total_appointments }}</h3>
                            <p>Appointments Today</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon pending-icon">
                            <i class="fas fa-hourglass-start"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ pending_count }}</h3>
                            <p>Pending Requests</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon completed-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ completed_count }}</h3>
                            <p>Completed Today</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon available-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ confirmed_count }}</h3>
                            <p>Confirmed Slots</p>
                        </div>
                    </div>
                </div>

                <!-- Main Dashboard Content Grid -->
                <div class="dashboard-content-grid">
                    <!-- Left Column: Appointments -->
                    <div class="dashboard-left-column">
                        <!-- Upcoming Appointments Preview -->
                        <div class="appointments-preview">
                            <div class="section-header">
                                <h2><i class="fas fa-calendar-day"></i> Next Appointments</h2>
                                <a href="#" class="view-all-link" onclick="showTodayView(event)">View All →</a>
                            </div>
                            {% if today_appointments %}
                                <div class="appointments-list">
                                    {% for appointment in today_appointments[:3] %}
                                        <div class="appointment-item">
                                            <div class="appointment-time-badge">
                                                <span class="time">{{ appointment.appointment_time }}</span>
                                            </div>
                                            <div class="appointment-info">
                                                <h4>{{ appointment.patient.username }}</h4>
                                                <p>{{ appointment.symptoms[:50] }}{% if appointment.symptoms|length > 50 %}...{% endif %}</p>
                                            </div>
                                            <span class="status-badge-mini status-{{ appointment.status|lower }}">
                                                {{ appointment.status|title }}
                                            </span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>No appointments today</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Right Column: Profile and Requests -->
                    <div class="dashboard-right-column">
                        <!-- Doctor Profile Quick View -->
                        <div class="doctor-profile-quick">
                            <div class="profile-quick-header">
                                <h2><i class="fas fa-user-md"></i> Your Profile</h2>
                            </div>
                            <div class="profile-quick-content">
                                <div class="profile-quick-avatar">
                                    {% if doctor.profile_image %}
                                        <img src="{{ url_for('serve_profile_picture', filename=doctor.profile_image.split('/')[-1]) }}" alt="{{ doctor.name }}">
                                    {% else %}
                                        <i class="fas fa-user-md"></i>
                                    {% endif %}
                                </div>
                                <div class="profile-quick-info">
                                    <h3>{{ doctor.name }}</h3>
                                    <p class="specialization">{{ doctor.specialization }}</p>
                                    <p class="experience"><i class="fas fa-award"></i> {{ doctor.experience }} years experience</p>
                                    <div class="profile-quick-actions">
                                        <button class="btn-text" onclick="showSettingsView(event)">
                                            <i class="fas fa-edit"></i> Edit Profile
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Appointment Requests Summary -->
                        <div class="requests-summary">
                            <div class="section-header">
                                <h2><i class="fas fa-bell"></i> Pending Requests</h2>
                                <a href="#" class="view-all-link" onclick="showRequestsView(event)">View All →</a>
                            </div>
                            <div class="request-summary-content">
                                <div class="request-stat">
                                    <div class="stat-number">{{ pending_count }}</div>
                                    <p>Awaiting Your Approval</p>
                                </div>
                                <button class="btn btn-primary" onclick="showRequestsView(event)">
                                    <i class="fas fa-list-check"></i> Review Requests
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Appointments View -->
            <div class="content-view today-view" id="todayView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-day"></i> Today's Appointments</h2>
                    <p class="date-display">{{ today.strftime('%A, %B %d, %Y') }}</p>
                </div>
                {% if today_appointments %}
                    <div class="appointments-table-container">
                        <div class="appointments-cards">
                            {% for appointment in today_appointments %}
                                <div class="appointment-card-detailed {{ appointment.status|lower }}">
                                    <div class="card-header">
                                        <div class="patient-section">
                                            <h3>{{ appointment.patient.username }}</h3>
                                            <p class="email">{{ appointment.patient.email }}</p>
                                        </div>
                                        <span class="status-badge status-{{ appointment.status|lower }}">
                                            {{ 'Approved' if appointment.status == 'confirmed' else appointment.status|title }}
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="appointment-detail">
                                            <i class="fas fa-clock"></i>
                                            <span>{{ appointment.appointment_time }}</span>
                                        </div>
                                        {% if appointment.symptoms %}
                                            <div class="appointment-detail">
                                                <i class="fas fa-notes-medical"></i>
                                                <span>{{ appointment.symptoms }}</span>
                                            </div>
                                        {% endif %}
                                        {% if appointment.notes %}
                                            <div class="appointment-detail">
                                                <i class="fas fa-sticky-note"></i>
                                                <span>{{ appointment.notes }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn btn-outline btn-sm">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                        {% if appointment.status == 'pending' %}
                                            <button class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button class="btn btn-danger btn-sm">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        {% elif appointment.status == 'confirmed' %}
                                            <button class="btn btn-primary btn-sm">
                                                <i class="fas fa-video"></i> Start Consultation
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="empty-state large">
                        <i class="fas fa-calendar-check"></i>
                        <h3>No Appointments Today</h3>
                        <p>Enjoy your break! You have no scheduled appointments.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Appointment Requests View -->
            <div class="content-view requests-view" id="requestsView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-clock"></i> Appointment Requests</h2>
                    <p class="subtitle">Review and approve pending appointment requests</p>
                </div>
                {% if pending_count > 0 %}
                    <div class="requests-container">
                        {% for appointment in today_appointments %}
                            {% if appointment.status == 'pending' %}
                                <div class="request-card">
                                    <div class="request-header">
                                        <h3>{{ appointment.patient.username }}</h3>
                                        <span class="request-time">Requested: {{ appointment.appointment_date.strftime('%b %d') }} at {{ appointment.appointment_time }}</span>
                                    </div>
                                    <div class="request-body">
                                        <div class="reason">
                                            <label>Reason for Visit:</label>
                                            <p>{{ appointment.symptoms }}</p>
                                        </div>
                                        {% if appointment.notes %}
                                            <div class="notes">
                                                <label>Additional Notes:</label>
                                                <p>{{ appointment.notes }}</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="request-actions">
                                        <button class="btn btn-success">
                                            <i class="fas fa-check-circle"></i> Approve
                                        </button>
                                        <button class="btn btn-danger">
                                            <i class="fas fa-times-circle"></i> Reject
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state large">
                        <i class="fas fa-inbox"></i>
                        <h3>No Pending Requests</h3>
                        <p>All appointment requests have been processed.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Schedule View -->
            <div class="content-view schedule-view" id="scheduleView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-alt"></i> My Schedule</h2>
                    <button class="btn btn-primary" onclick="showEditScheduleModal()">
                        <i class="fas fa-edit"></i> Edit Availability
                    </button>
                </div>
                <div class="schedule-card">
                    <div class="schedule-info">
                        <div class="schedule-item">
                            <label><i class="fas fa-calendar"></i> Available Days</label>
                            <p>{{ doctor.available_days }}</p>
                        </div>
                        <div class="schedule-item">
                            <label><i class="fas fa-clock"></i> Available Hours</label>
                            <p>{{ doctor.available_time }}</p>
                        </div>
                        <div class="schedule-item">
                            <label><i class="fas fa-dollar-sign"></i> Consultation Fee</label>
                            <p>${{ "%.2f"|format(doctor.consultation_fee) }}</p>
                        </div>
                    </div>
                    <div class="schedule-preview">
                        <h3>Weekly Schedule</h3>
                        <div class="weekly-grid">
                            <div class="day-slot">
                                <span class="day">Mon</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Tue</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Wed</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Thu</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Fri</span>
                                <span class="time">09:00-17:00</span>
                                <span class="status available">Available</span>
                            </div>
                            <div class="day-slot">
                                <span class="day">Sat</span>
                                <span class="time">10:00-14:00</span>
                                <span class="status available">Available</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div class="content-view settings-view" id="settingsView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Profile Settings</h2>
                </div>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3><i class="fas fa-user"></i> Personal Information</h3>
                        <div class="settings-item">
                            <label>Full Name</label>
                            <p>{{ doctor.name }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Specialization</label>
                            <p>{{ doctor.specialization }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Qualifications</label>
                            <p>{{ doctor.qualifications }}</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditProfileModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-phone"></i> Contact Information</h3>
                        <div class="settings-item">
                            <label>Email</label>
                            <p>{{ doctor.email }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Phone</label>
                            <p>{{ doctor.phone }}</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditContactModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-lock"></i> Account Security</h3>
                        <div class="settings-item">
                            <label>Password</label>
                            <p>••••••••</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showChangePasswordModal()">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div id="editScheduleModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-alt"></i> Edit Availability</h3>
            <button class="close-modal" onclick="closeModal('editScheduleModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editScheduleForm">
                <!-- Available Days Section -->
                <div class="form-group">
                    <label class="form-label-bold"><i class="fas fa-calendar-check"></i> Available Days</label>
                    <div class="days-checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_monday" name="days" value="Monday">
                            <label for="day_monday">Monday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_tuesday" name="days" value="Tuesday">
                            <label for="day_tuesday">Tuesday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_wednesday" name="days" value="Wednesday">
                            <label for="day_wednesday">Wednesday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_thursday" name="days" value="Thursday">
                            <label for="day_thursday">Thursday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_friday" name="days" value="Friday">
                            <label for="day_friday">Friday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_saturday" name="days" value="Saturday">
                            <label for="day_saturday">Saturday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_sunday" name="days" value="Sunday">
                            <label for="day_sunday">Sunday</label>
                        </div>
                    </div>
                    <small>Select the days you are available</small>
                </div>

                <!-- Available Time Section -->
                <div class="form-group">
                    <label class="form-label-bold"><i class="fas fa-clock"></i> Available Hours</label>
                    <div class="time-range-container">
                        <div class="time-input-group">
                            <label for="start_time">From</label>
                            <input type="time" id="start_time" name="start_time" required>
                        </div>
                        <span class="time-separator">to</span>
                        <div class="time-input-group">
                            <label for="end_time">To</label>
                            <input type="time" id="end_time" name="end_time" required>
                        </div>
                    </div>
                    <small>Select your available time range</small>
                </div>

                <!-- Consultation Fee Section -->
                <div class="form-group">
                    <label for="consultation_fee"><i class="fas fa-dollar-sign"></i> Consultation Fee ($)</label>
                    <input type="number" id="consultation_fee" name="consultation_fee" 
                           value="{{ doctor.consultation_fee }}" 
                           step="0.01" min="0"
                           placeholder="e.g., 50.00"
                           required>
                    <small>Enter the consultation fee per appointment</small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editScheduleModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user"></i> Edit Profile</h3>
            <button class="close-modal" onclick="closeModal('editProfileModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="edit_name">Full Name</label>
                    <input type="text" id="edit_name" name="name" value="{{ doctor.name }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_specialization">Specialization</label>
                    <input type="text" id="edit_specialization" name="specialization" value="{{ doctor.specialization }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_qualifications">Qualifications</label>
                    <textarea id="edit_qualifications" name="qualifications" rows="3" required>{{ doctor.qualifications }}</textarea>
                </div>
                <div class="form-group">
                    <label for="edit_experience">Years of Experience</label>
                    <input type="number" id="edit_experience" name="experience" value="{{ doctor.experience }}" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editProfileModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div id="editContactModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-phone"></i> Edit Contact Information</h3>
            <button class="close-modal" onclick="closeModal('editContactModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editContactForm">
                <div class="form-group">
                    <label for="edit_email">Email Address</label>
                    <input type="email" id="edit_email" name="email" value="{{ doctor.email }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_phone">Phone Number</label>
                    <input type="tel" id="edit_phone" name="phone" value="{{ doctor.phone }}" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editContactModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Change Password</h3>
            <button class="close-modal" onclick="closeModal('changePasswordModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password" name="current_password" required>
                </div>
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" minlength="6" required>
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" minlength="6" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('changePasswordModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showDashboardView(event) {
    event.preventDefault();
    showView('dashboardView');
    setActiveNav(event.target.closest('.nav-item'));
}

function showTodayView(event) {
    event.preventDefault();
    showView('todayView');
    setActiveNav(document.querySelector('[onclick*="showTodayView"]'));
}

function showRequestsView(event) {
    event.preventDefault();
    showView('requestsView');
    setActiveNav(document.querySelector('[onclick*="showRequestsView"]'));
}

function showScheduleView(event) {
    event.preventDefault();
    showView('scheduleView');
    setActiveNav(document.querySelector('[onclick*="showScheduleView"]'));
}

function showSettingsView(event) {
    event.preventDefault();
    showView('settingsView');
    setActiveNav(document.querySelector('[onclick*="showSettingsView"]'));
}

function showView(viewId) {
    const views = document.querySelectorAll('.content-view');
    views.forEach(view => view.style.display = 'none');
    document.getElementById(viewId).style.display = 'block';
}

function setActiveNav(element) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (element) element.classList.add('active');
}

function showEditScheduleModal() {
    document.getElementById('editScheduleModal').style.display = 'flex';
}

function showEditProfileModal() {
    document.getElementById('editProfileModal').style.display = 'flex';
}

function showEditContactModal() {
    document.getElementById('editContactModal').style.display = 'flex';
}

function showChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// Handle Edit Schedule Form
document.addEventListener('DOMContentLoaded', function() {
    // Parse existing schedule to populate checkboxes and time inputs
    const populateScheduleForm = function() {
        const availableDaysStr = "{{ doctor.available_days }}";
        const availableTimeStr = "{{ doctor.available_time }}";
        
        // Parse days and check corresponding checkboxes
        if (availableDaysStr) {
            const days = availableDaysStr.split(',').map(d => d.trim());
            days.forEach(day => {
                const checkbox = document.getElementById(`day_${day.toLowerCase()}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        // Parse time range (HH:MM-HH:MM format) and populate time inputs
        if (availableTimeStr && availableTimeStr.includes('-')) {
            const [startTime, endTime] = availableTimeStr.split('-').map(t => t.trim());
            const startInput = document.getElementById('start_time');
            const endInput = document.getElementById('end_time');
            
            if (startTime && startInput) {
                startInput.value = startTime;
            }
            if (endTime && endInput) {
                endInput.value = endTime;
            }
        }
    };
    
    // Call on page load
    populateScheduleForm();
    
    // Handle form submission
    const editScheduleForm = document.getElementById('editScheduleForm');
    if (editScheduleForm) {
        editScheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get checked days
            const dayCheckboxes = document.querySelectorAll('input[name="days"]:checked');
            if (dayCheckboxes.length === 0) {
                alert('Please select at least one day');
                return;
            }
            
            const availableDays = Array.from(dayCheckboxes)
                .map(checkbox => checkbox.value)
                .join(',');
            
            // Get time range
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            
            if (!startTime || !endTime) {
                alert('Please select both start and end time');
                return;
            }
            
            if (startTime >= endTime) {
                alert('End time must be after start time');
                return;
            }
            
            const availableTime = `${startTime}-${endTime}`;
            
            // Get consultation fee
            const consultationFee = document.getElementById('consultation_fee').value;
            
            if (!consultationFee || parseFloat(consultationFee) < 0) {
                alert('Please enter a valid consultation fee');
                return;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('available_days', availableDays);
            formData.append('available_time', availableTime);
            formData.append('consultation_fee', consultationFee);
            
            // Send request
            fetch('/doctor/update-schedule', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Schedule updated successfully!');
                    closeModal('editScheduleModal');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to update schedule'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }

    // Handle Edit Profile Form
    const editProfileForm = document.getElementById('editProfileForm');
    if (editProfileForm) {
        editProfileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/doctor/update-profile', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile updated successfully!');
                    closeModal('editProfileModal');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to update profile'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }

    // Handle Edit Contact Form
    const editContactForm = document.getElementById('editContactForm');
    if (editContactForm) {
        editContactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/doctor/update-contact', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Contact information updated successfully!');
                    closeModal('editContactModal');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to update contact information'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }

    // Handle Change Password Form
    const changePasswordForm = document.getElementById('changePasswordForm');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            const formData = new FormData(this);
            
            fetch('/doctor/change-password', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password changed successfully!');
                    closeModal('changePasswordModal');
                    this.reset();
                } else {
                    alert('Error: ' + (data.message || 'Failed to change password'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }
});

</script>
{% endblock %}
