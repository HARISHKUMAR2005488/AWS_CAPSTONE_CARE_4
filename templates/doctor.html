{% extends "base.html" %}

{% block title %}Doctor Dashboard - Care_4_U Hospitals{% endblock %}

{% block content %}
<style>
    /* Hide navbar and footer for doctor dashboard */
    .navbar, .footer, .flash-messages {
        display: none !important;
    }
    body {
        margin: 0;
        padding: 0;
    }
    main {
        padding: 0;
        margin: 0;
    }
    
    /* Patient Details Styles */
    .patients-view .appointments-table {
        width: 100%;
        overflow-x: auto;
    }

    .patients-view .appointments-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .patient-row {
        transition: background-color 0.2s;
    }

    .patient-row:hover {
        background-color: rgba(95, 254, 190, 0.1) !important;
    }

    .patient-row td {
        padding: 12px;
        vertical-align: middle;
    }

    .patient-details-row {
        background-color: #f8f9fa !important;
    }

    .patient-details-row td {
        padding: 0 !important;
    }

    .patient-details-container {
        padding: 30px;
        animation: slideDown 0.3s ease-in-out;
        max-width: 100%;
        margin: 0 auto;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .patient-info-card-expanded {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .info-header-expanded {
        display: flex;
        gap: 25px;
        align-items: flex-start;
        flex-wrap: wrap;
    }

    .patient-avatar-expanded {
        font-size: 70px;
        color: #5FEABE;
        line-height: 1;
    }

    .patient-details-expanded {
        flex: 1;
        min-width: 300px;
    }

    .patient-details-expanded h3 {
        margin: 0 0 20px 0;
        color: #1D1B1B;
        font-size: 24px;
        font-weight: 600;
    }

    .detail-grid-expanded {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 12px;
        margin-top: 15px;
    }

    .detail-item-expanded {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #5FEABE;
    }

    .detail-item-expanded i {
        color: #5FEABE;
        width: 20px;
        font-size: 16px;
    }

    .detail-item-expanded span {
        font-size: 14px;
        color: #333;
    }

    .info-stats-expanded {
        margin-top: 25px;
        padding-top: 25px;
        border-top: 2px solid #e0e0e0;
    }

    .stat-box-expanded {
        display: inline-flex;
        align-items: center;
        gap: 15px;
        padding: 15px 25px;
        background: linear-gradient(135deg, #E4FECA 0%, #d4f4ba 100%);
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(95, 254, 190, 0.2);
    }

    .stat-box-expanded .stat-icon {
        font-size: 32px;
        color: #5FEABE;
    }

    .stat-box-expanded h4 {
        margin: 0;
        font-size: 28px;
        color: #1D1B1B;
        font-weight: 700;
    }

    .stat-box-expanded p {
        margin: 0;
        color: #666;
        font-size: 14px;
        font-weight: 500;
    }

    .appointments-history-section {
        margin-top: 25px;
    }

    .section-header-expanded {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .section-header-expanded h3 {
        color: #1D1B1B;
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }

    .section-header-expanded h3 i {
        color: #5FEABE;
        margin-right: 8px;
    }

    .appointment-count-badge-small {
        background: #5FEABE;
        color: #1D1B1B;
        padding: 8px 18px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(95, 254, 190, 0.3);
    }

    .appointment-count-badge-small i {
        margin-right: 6px;
    }

    .view-records-btn {
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .view-records-btn.active {
        background: #dc3545 !important;
        transform: scale(0.98);
    }

    .view-records-btn.active i:before {
        content: "\f146" !important; /* fa-folder-minus */
    }

    .patient-cell {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .patient-cell i {
        font-size: 28px;
        color: #5FEABE;
    }

    .patient-cell strong {
        font-size: 15px;
        color: #1D1B1B;
    }

    .appointments-history-section .appointments-table {
        margin-top: 15px;
    }

    .appointments-history-section .appointments-table table {
        background: white;
    }

    .datetime-cell {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .datetime-cell .date {
        font-weight: 600;
        color: #1D1B1B;
    }

    .datetime-cell .time {
        font-size: 13px;
        color: #666;
    }

    .symptoms-text {
        display: block;
        line-height: 1.5;
        color: #333;
    }

    .notes-preview {
        line-height: 1.5;
        color: #555;
    }

    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 40px 20px !important;
    }

    .loading-spinner i {
        color: #5FEABE;
    }

    .loading-spinner p {
        color: #666;
        margin: 0;
        font-size: 14px;
    }

    /* Medical Records Section */
    .medical-records-section {
        margin-top: 25px;
    }

    .medical-records-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .medical-record-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        gap: 15px;
        align-items: flex-start;
        transition: all 0.3s ease;
    }

    .medical-record-card:hover {
        border-color: #5FEABE;
        box-shadow: 0 4px 12px rgba(95, 254, 190, 0.2);
        transform: translateY(-2px);
    }

    .medical-record-card .record-icon {
        font-size: 36px;
        color: #5FEABE;
        width: 50px;
        text-align: center;
        flex-shrink: 0;
    }

    .medical-record-card .record-icon .fa-file-pdf {
        color: #dc3545;
    }

    .medical-record-card .record-icon .fa-file-image {
        color: #17a2b8;
    }

    .medical-record-card .record-icon .fa-file-word {
        color: #2b5797;
    }

    .medical-record-card .record-icon .fa-file-excel {
        color: #1d6f42;
    }

    .medical-record-card .record-details {
        flex: 1;
        min-width: 0;
    }

    .medical-record-card .record-details h4 {
        margin: 0 0 8px 0;
        font-size: 15px;
        font-weight: 600;
        color: #1D1B1B;
        word-break: break-word;
    }

    .medical-record-card .record-meta {
        margin: 0 0 8px 0;
        font-size: 13px;
        color: #666;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .medical-record-card .record-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .medical-record-card .record-meta i {
        color: #5FEABE;
        font-size: 12px;
    }

    .medical-record-card .record-description {
        margin: 0;
        font-size: 13px;
        color: #777;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .medical-record-card .record-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
    }

    .medical-record-card .record-actions .btn {
        padding: 8px 12px;
        font-size: 14px;
        min-width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-outline-primary {
        background: transparent;
        border: 1px solid #5FEABE;
        color: #5FEABE;
    }

    .btn-outline-primary:hover {
        background: #5FEABE;
        color: white;
    }
</style>
<div class="doctor-container">
    <!-- Top Header -->
    <div class="doctor-header">
        <div class="header-left">
            <div class="logo-section">
                <i class="fas fa-heart"></i>
                <span>Care_4_U Hospitals</span>
            </div>
            <h1>Doctor Dashboard</h1>
        </div>
        <div class="header-right">
            <div class="doctor-info-header">
                <div class="doctor-avatar-header">
                    {% if doctor.profile_image %}
                        <img src="{{ url_for('serve_profile_picture', filename=doctor.profile_image.split('/')[-1]) }}" alt="{{ doctor.name }}">
                    {% else %}
                        <i class="fas fa-user-md"></i>
                    {% endif %}
                </div>
                <div class="doctor-details-header">
                    <h3>{{ doctor.name }}</h3>
                    <p>{{ doctor.specialization }}</p>
                </div>
            </div>
            <button class="btn-logout" onclick="location.href='{{ url_for('logout') }}'">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="doctor-dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="doctor-sidebar">
            <nav class="doctor-nav">
                <a href="#" class="nav-item active" onclick="showDashboardView(event)">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" onclick="showPatientsView(event)">
                    <i class="fas fa-user-injured"></i>
                    <span>Patient Records</span>
                </a>
                <a href="#" class="nav-item" onclick="showRequestsView(event)">
                    <i class="fas fa-clock"></i>
                    <span>Appointment Requests</span>
                </a>
                <a href="#" class="nav-item" onclick="showScheduleView(event)">
                    <i class="fas fa-calendar-alt"></i>
                    <span>My Schedule</span>
                </a>
                <a href="#" class="nav-item" onclick="showSettingsView(event)">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="doctor-main-content">
            <!-- Dashboard View -->
            <div class="content-view dashboard-view" id="dashboardView">
                <!-- Overview Cards -->
                <div class="overview-grid">
                    <div class="overview-card">
                        <div class="card-icon appointments-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ today_appointments|length }}</h3>
                            <p>Appointments Today</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon completed-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ completed_count }}</h3>
                            <p>Completed Today</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon available-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ confirmed_count }}</h3>
                            <p>Confirmed Slots</p>
                        </div>
                    </div>
                    
                    <div class="overview-card">
                        <div class="card-icon total-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="card-content">
                            <h3>{{ total_appointments }}</h3>
                            <p>Overall Total Appointments</p>
                        </div>
                    </div>
                </div>

                <!-- Main Dashboard Content Grid -->
                <div class="dashboard-content-grid">
                    <!-- Left Column: Appointments -->
                    <div class="dashboard-left-column">
                        <!-- Upcoming Confirmed Appointments Preview -->
                        <div class="appointments-preview">
                            <div class="section-header">
                                <h2><i class="fas fa-calendar-check"></i> Next Appointments</h2>
                                <a href="#" class="view-all-link" onclick="showTodayView(event)">View All →</a>
                            </div>
                            {% if appointments %}
                                {% set confirmed_appointments = [] %}
                                {% for appt in appointments %}
                                    {% if appt.status and appt.status.lower() == 'confirmed' %}
                                        {% set _ = confirmed_appointments.append(appt) %}
                                    {% endif %}
                                {% endfor %}
                                {% if confirmed_appointments %}
                                    <div class="appointments-list">
                                        {% for appointment in confirmed_appointments[:3] %}
                                            <div class="appointment-item">
                                                <div class="appointment-time-badge">
                                                    <span class="time">{{ appointment.appointment_time }}</span>
                                                    <span class="date">{{ appointment.appointment_date.strftime('%b %d') if appointment.appointment_date else '' }}</span>
                                                </div>
                                                <div class="appointment-info">
                                                    <h4>{{ appointment.patient.name or appointment.patient.username }}</h4>
                                                    <p>{{ appointment.symptoms[:50] if appointment.symptoms else 'No symptoms noted' }}{% if appointment.symptoms and appointment.symptoms|length > 50 %}...{% endif %}</p>
                                                </div>
                                                <span class="status-badge-mini status-confirmed">
                                                    Confirmed
                                                </span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <p>No confirmed appointments</p>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>No confirmed appointments</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Right Column: Additional Info -->
                    <div class="dashboard-right-column">
                        <!-- Empty for future use -->
                    </div>
                </div>
            </div>

            <!-- Today's Appointments View -->
            <div class="content-view today-view" id="todayView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-day"></i> Today's Appointments</h2>
                    <p class="date-display">{{ today.strftime('%A, %B %d, %Y') }}</p>
                </div>
                {% if today_appointments %}
                    <div class="appointments-table-container">
                        <div class="appointments-cards">
                            {% for appointment in today_appointments %}
                                <div class="appointment-card-detailed {{ appointment.status|lower }}">
                                    <div class="card-header">
                                        <div class="patient-section">
                                            <h3>{{ appointment.patient.username }}</h3>
                                            <p class="email">{{ appointment.patient.email }}</p>
                                        </div>
                                        <span class="status-badge status-{{ appointment.status|lower }}">
                                            {{ 'Approved' if appointment.status == 'confirmed' else appointment.status|title }}
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="appointment-detail">
                                            <i class="fas fa-clock"></i>
                                            <span>{{ appointment.appointment_time }}</span>
                                        </div>
                                        {% if appointment.symptoms %}
                                            <div class="appointment-detail">
                                                <i class="fas fa-notes-medical"></i>
                                                <span>{{ appointment.symptoms }}</span>
                                            </div>
                                        {% endif %}
                                        {% if appointment.notes %}
                                            <div class="appointment-detail">
                                                <i class="fas fa-sticky-note"></i>
                                                <span>{{ appointment.notes }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn btn-outline btn-sm">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                        {% if appointment.status == 'pending' %}
                                            <button class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button class="btn btn-danger btn-sm">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        {% elif appointment.status == 'confirmed' %}
                                            <button class="btn btn-primary btn-sm">
                                                <i class="fas fa-video"></i> Start Consultation
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="empty-state large">
                        <i class="fas fa-calendar-check"></i>
                        <h3>No Appointments Today</h3>
                        <p>Enjoy your break! You have no scheduled appointments.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Appointment Requests View -->
            <div class="content-view requests-view" id="requestsView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-clock"></i> Appointment Requests</h2>
                    <p class="subtitle">Review and approve pending appointment requests</p>
                </div>
                {% if pending_count > 0 %}
                    <div class="requests-container">
                        {% for appointment in pending_appointments %}
                                <div class="request-card">
                                    <div class="request-header">
                                        <div>
                                            <h3><i class="fas fa-user-circle"></i> {{ appointment.patient.name or appointment.patient.username }}</h3>
                                            <span class="patient-username">@{{ appointment.patient.username }}</span>
                                        </div>
                                        <span class="status-badge status-pending">Pending</span>
                                    </div>
                                    
                                    <div class="patient-info">
                                        <div class="info-row">
                                            <div class="info-item">
                                                <i class="fas fa-calendar-alt"></i>
                                                <span><strong>Date:</strong> {{ appointment.appointment_date.strftime('%B %d, %Y') }}</span>
                                            </div>
                                            <div class="info-item">
                                                <i class="fas fa-clock"></i>
                                                <span><strong>Time:</strong> {{ appointment.appointment_time }}</span>
                                            </div>
                                        </div>
                                        <div class="info-row">
                                            {% if appointment.patient.email %}
                                            <div class="info-item">
                                                <i class="fas fa-envelope"></i>
                                                <span>{{ appointment.patient.email }}</span>
                                            </div>
                                            {% endif %}
                                            {% if appointment.patient.phone %}
                                            <div class="info-item">
                                                <i class="fas fa-phone"></i>
                                                <span>{{ appointment.patient.phone }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="info-row">
                                            {% if appointment.patient.age %}
                                            <div class="info-item">
                                                <i class="fas fa-birthday-cake"></i>
                                                <span><strong>Age:</strong> {{ appointment.patient.age }} years</span>
                                            </div>
                                            {% endif %}
                                            {% if appointment.patient.gender %}
                                            <div class="info-item">
                                                <i class="fas fa-venus-mars"></i>
                                                <span><strong>Gender:</strong> {{ appointment.patient.gender }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="request-body">
                                        <div class="reason">
                                            <label><i class="fas fa-notes-medical"></i> Reason for Visit:</label>
                                            <p>{{ appointment.symptoms or 'Not specified' }}</p>
                                        </div>
                                        {% if appointment.notes %}
                                            <div class="notes">
                                                <label><i class="fas fa-comment-medical"></i> Additional Notes:</label>
                                                <p>{{ appointment.notes }}</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="request-actions">
                                        <button class="btn btn-success" onclick="approveAppointment('{{ appointment.id }}', '{{ appointment.patient.name or appointment.patient.username }}', '{{ appointment.appointment_date.strftime('%b %d, %Y') }}', '{{ appointment.appointment_time }}')">
                                            <i class="fas fa-check-circle"></i> Approve
                                        </button>
                                        <button class="btn btn-danger" onclick="rejectAppointment('{{ appointment.id }}', '{{ appointment.patient.name or appointment.patient.username }}')">
                                            <i class="fas fa-times-circle"></i> Reject
                                        </button>
                                    </div>
                                </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state large">
                        <i class="fas fa-inbox"></i>
                        <h3>No Pending Requests</h3>
                        <p>All appointment requests have been processed.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Schedule View -->
            <div class="content-view schedule-view" id="scheduleView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-alt"></i> My Schedule</h2>
                    <button class="btn btn-primary" onclick="showEditScheduleModal()">
                        <i class="fas fa-edit"></i> Edit Availability
                    </button>
                </div>
                <div class="schedule-card">
                    <div class="schedule-info">
                        <div class="schedule-item">
                            <label><i class="fas fa-calendar"></i> Available Days</label>
                            <p>{{ doctor.available_days }}</p>
                        </div>
                        <div class="schedule-item">
                            <label><i class="fas fa-clock"></i> Available Hours</label>
                            <p>{{ doctor.available_time }}</p>
                        </div>
                        <div class="schedule-item">
                            <label><i class="fas fa-dollar-sign"></i> Consultation Fee</label>
                            <p>${{ "%.2f"|format(doctor.consultation_fee) }}</p>
                        </div>
                    </div>
                    <div class="schedule-preview">
                        <h3>Weekly Schedule</h3>
                        <div class="weekly-grid" id="weeklyScheduleGrid">
                            <!-- Dynamic schedule will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Records View -->
            <div class="content-view patients-view" id="patientsView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> My Patients</h2>
                    <div class="patient-count-badge">
                        <i class="fas fa-user-injured"></i>
                        <span>{{ patient_data|length if patient_data else 0 }} Patient{% if patient_data and patient_data|length != 1 %}s{% endif %}</span>
                    </div>
                </div>
                
                {% if patient_data %}
                    <div class="appointments-table">
                        <table id="patientsTable">
                            <thead>
                                <tr>
                                    <th>Patient Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Total Appointments</th>
                                    <th>Last Appointment</th>
                                    <th>Medical Records</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in patient_data %}
                                    <tr class="patient-row" data-patient-id="{{ data.patient.id }}">
                                        <td>
                                            <div class="patient-cell">
                                                <i class="fas fa-user-circle"></i>
                                                <strong>{{ data.patient.username }}</strong>
                                            </div>
                                        </td>
                                        <td>{{ data.patient.email }}</td>
                                        <td>{{ data.patient.phone or 'N/A' }}</td>
                                        <td>
                                            <span class="badge">{{ data.total_appointments }}</span>
                                        </td>
                                        <td>
                                            {% if data.last_appointment %}
                                                {{ data.last_appointment.strftime('%b %d, %Y') }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge {% if data.medical_records_count > 0 %}badge-success{% else %}badge-secondary{% endif %}">
                                                {{ data.medical_records_count }} 
                                                {% if data.medical_records_count == 1 %}
                                                    document
                                                {% else %}
                                                    documents
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <button onclick="togglePatientDetails('{{ data.patient.id }}', this)" 
                                                    class="btn btn-primary btn-sm view-records-btn">
                                                <i class="fas fa-folder-open"></i> View Records
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Expandable Detail Row -->
                                    <tr class="patient-details-row" id="details-{{ data.patient.id }}" style="display: none;">
                                        <td colspan="7">
                                            <div class="patient-details-container">
                                                <div class="loading-spinner" style="text-align: center; padding: 20px;">
                                                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                                                    <p>Loading patient details...</p>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-users-slash"></i>
                        <p>No patients found. Patients will appear here once they book appointments with you.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Settings View -->
            <div class="content-view settings-view" id="settingsView" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Profile Settings</h2>
                </div>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3><i class="fas fa-user"></i> Personal Information</h3>
                        <div class="settings-item">
                            <label>Full Name</label>
                            <p>{{ doctor.name }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Specialization</label>
                            <p>{{ doctor.specialization }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Qualifications</label>
                            <p>{{ doctor.qualifications }}</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditProfileModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-phone"></i> Contact Information</h3>
                        <div class="settings-item">
                            <label>Email</label>
                            <p>{{ doctor.email }}</p>
                        </div>
                        <div class="settings-item">
                            <label>Phone</label>
                            <p>{{ doctor.phone }}</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditContactModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-lock"></i> Account Security</h3>
                        <div class="settings-item">
                            <label>Password</label>
                            <p>••••••••</p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showChangePasswordModal()">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div id="editScheduleModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-alt"></i> Edit Availability</h3>
            <button class="close-modal" onclick="closeModal('editScheduleModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editScheduleForm">
                <!-- Available Days Section -->
                <div class="form-group">
                    <label class="form-label-bold"><i class="fas fa-calendar-check"></i> Available Days</label>
                    <div class="days-checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_monday" name="days" value="Monday">
                            <label for="day_monday">Monday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_tuesday" name="days" value="Tuesday">
                            <label for="day_tuesday">Tuesday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_wednesday" name="days" value="Wednesday">
                            <label for="day_wednesday">Wednesday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_thursday" name="days" value="Thursday">
                            <label for="day_thursday">Thursday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_friday" name="days" value="Friday">
                            <label for="day_friday">Friday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_saturday" name="days" value="Saturday">
                            <label for="day_saturday">Saturday</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="day_sunday" name="days" value="Sunday">
                            <label for="day_sunday">Sunday</label>
                        </div>
                    </div>
                    <small>Select the days you are available</small>
                </div>

                <!-- Available Time Section -->
                <div class="form-group">
                    <label class="form-label-bold"><i class="fas fa-clock"></i> Available Hours</label>
                    <div class="time-range-container">
                        <div class="time-input-group">
                            <label for="start_time">From</label>
                            <input type="time" id="start_time" name="start_time" required>
                        </div>
                        <span class="time-separator">to</span>
                        <div class="time-input-group">
                            <label for="end_time">To</label>
                            <input type="time" id="end_time" name="end_time" required>
                        </div>
                    </div>
                    <small>Select your available time range</small>
                </div>

                <!-- Consultation Fee Section -->
                <div class="form-group">
                    <label for="consultation_fee"><i class="fas fa-dollar-sign"></i> Consultation Fee ($)</label>
                    <input type="number" id="consultation_fee" name="consultation_fee" 
                           value="{{ doctor.consultation_fee }}" 
                           step="0.01" min="0"
                           placeholder="e.g., 50.00"
                           required>
                    <small>Enter the consultation fee per appointment</small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editScheduleModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user"></i> Edit Profile</h3>
            <button class="close-modal" onclick="closeModal('editProfileModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="edit_name">Full Name</label>
                    <input type="text" id="edit_name" name="name" value="{{ doctor.name }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_specialization">Specialization</label>
                    <input type="text" id="edit_specialization" name="specialization" value="{{ doctor.specialization }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_qualifications">Qualifications</label>
                    <textarea id="edit_qualifications" name="qualifications" rows="3" required>{{ doctor.qualifications }}</textarea>
                </div>
                <div class="form-group">
                    <label for="edit_experience">Years of Experience</label>
                    <input type="number" id="edit_experience" name="experience" value="{{ doctor.experience }}" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editProfileModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div id="editContactModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-phone"></i> Edit Contact Information</h3>
            <button class="close-modal" onclick="closeModal('editContactModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editContactForm">
                <div class="form-group">
                    <label for="edit_email">Email Address</label>
                    <input type="email" id="edit_email" name="email" value="{{ doctor.email }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_phone">Phone Number</label>
                    <input type="tel" id="edit_phone" name="phone" value="{{ doctor.phone }}" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editContactModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Change Password</h3>
            <button class="close-modal" onclick="closeModal('changePasswordModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password" name="current_password" required>
                </div>
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" minlength="6" required>
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" minlength="6" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('changePasswordModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showDashboardView(event) {
    event.preventDefault();
    showView('dashboardView');
    setActiveNav(event.target.closest('.nav-item'));
}

function showPatientsView(event) {
    event.preventDefault();
    showView('patientsView');
    setActiveNav(document.querySelector('[onclick*="showPatientsView"]'));
}

function showTodayView(event) {
    event.preventDefault();
    showView('todayView');
    setActiveNav(document.querySelector('[onclick*="showTodayView"]'));
}

function showRequestsView(event) {
    event.preventDefault();
    showView('requestsView');
    setActiveNav(document.querySelector('[onclick*="showRequestsView"]'));
}

function showScheduleView(event) {
    event.preventDefault();
    showView('scheduleView');
    setActiveNav(document.querySelector('[onclick*="showScheduleView"]'));
}

function showSettingsView(event) {
    event.preventDefault();
    showView('settingsView');
    setActiveNav(document.querySelector('[onclick*="showSettingsView"]'));
}

function showView(viewId) {
    const views = document.querySelectorAll('.content-view');
    views.forEach(view => view.style.display = 'none');
    document.getElementById(viewId).style.display = 'block';
}

function setActiveNav(element) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (element) element.classList.add('active');
}

function showEditScheduleModal() {
    // Re-populate the form with current values before showing
    if (window.populateScheduleFormFn) {
        window.populateScheduleFormFn();
    }
    document.getElementById('editScheduleModal').style.display = 'flex';
}

function showEditProfileModal() {
    document.getElementById('editProfileModal').style.display = 'flex';
}

function showEditContactModal() {
    document.getElementById('editContactModal').style.display = 'flex';
}

function showChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// Handle Edit Schedule Form
document.addEventListener('DOMContentLoaded', function() {
    // Parse existing schedule to populate checkboxes and time inputs
    const populateScheduleForm = function() {
        const availableDaysStr = "{{ doctor.available_days }}";
        const availableTimeStr = "{{ doctor.available_time }}";
        
        // Parse days and check corresponding checkboxes
        if (availableDaysStr) {
            const days = availableDaysStr.split(',').map(d => d.trim());
            
            // First uncheck all boxes
            document.querySelectorAll('input[name="days"]').forEach(cb => cb.checked = false);
            
            // Then check the available days
            days.forEach(day => {
                const checkbox = document.getElementById(`day_${day.toLowerCase()}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        // Parse time range (HH:MM-HH:MM format) and populate time inputs
        if (availableTimeStr && availableTimeStr.includes('-')) {
            const [startTime, endTime] = availableTimeStr.split('-').map(t => t.trim());
            const startInput = document.getElementById('start_time');
            const endInput = document.getElementById('end_time');
            
            if (startTime && startInput) {
                startInput.value = startTime;
            }
            if (endTime && endInput) {
                endInput.value = endTime;
            }
        }
    };
    
    // Make it globally accessible
    window.populateScheduleFormFn = populateScheduleForm;
    
    // Render weekly schedule dynamically
    const renderWeeklySchedule = function() {
        const availableDaysStr = "{{ doctor.available_days if doctor.available_days else '' }}";
        const availableTimeStr = "{{ doctor.available_time if doctor.available_time else '' }}";
        const weeklyGrid = document.getElementById('weeklyScheduleGrid');
        
        console.log('Rendering schedule with:', { availableDaysStr, availableTimeStr });
        
        if (!weeklyGrid) {
            console.warn('Weekly grid element not found');
            return;
        }
        
        // All days of the week
        const allDays = [
            { short: 'Mon', full: 'Monday' },
            { short: 'Tue', full: 'Tuesday' },
            { short: 'Wed', full: 'Wednesday' },
            { short: 'Thu', full: 'Thursday' },
            { short: 'Fri', full: 'Friday' },
            { short: 'Sat', full: 'Saturday' },
            { short: 'Sun', full: 'Sunday' }
        ];
        
        // Parse available days - handle both comma-separated and whitespace
        let availableDays = [];
        if (availableDaysStr && availableDaysStr.trim()) {
            availableDays = availableDaysStr.split(',').map(d => d.trim()).filter(d => d);
            console.log('Parsed available days:', availableDays);
        }
        
        // Clear existing content
        weeklyGrid.innerHTML = '';
        
        // Render each day
        allDays.forEach(day => {
            const isAvailable = availableDays.some(availDay => 
                availDay.toLowerCase() === day.full.toLowerCase()
            );
            const daySlot = document.createElement('div');
            daySlot.className = 'day-slot';
            
            daySlot.innerHTML = `
                <span class="day">${day.short}</span>
                <span class="time">${isAvailable && availableTimeStr ? availableTimeStr : '--:--'}</span>
                <span class="status ${isAvailable ? 'available' : 'unavailable'}">
                    ${isAvailable ? 'Available' : 'Not Available'}
                </span>
            `;
            
            weeklyGrid.appendChild(daySlot);
        });
        
        console.log('Weekly schedule rendered successfully');
    };
    
    // Call on page load
    populateScheduleForm();
    renderWeeklySchedule();
    
    // Handle form submission
    const editScheduleForm = document.getElementById('editScheduleForm');
    if (editScheduleForm) {
        editScheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get checked days
            const dayCheckboxes = document.querySelectorAll('input[name="days"]:checked');
            if (dayCheckboxes.length === 0) {
                alert('Please select at least one day');
                return;
            }
            
            const availableDays = Array.from(dayCheckboxes)
                .map(checkbox => checkbox.value)
                .join(',');
            
            // Get time range
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            
            if (!startTime || !endTime) {
                alert('Please select both start and end time');
                return;
            }
            
            if (startTime >= endTime) {
                alert('End time must be after start time');
                return;
            }
            
            const availableTime = `${startTime}-${endTime}`;
            
            // Get consultation fee
            const consultationFee = document.getElementById('consultation_fee').value;
            
            if (!consultationFee || parseFloat(consultationFee) < 0) {
                alert('Please enter a valid consultation fee');
                return;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('available_days', availableDays);
            formData.append('available_time', availableTime);
            formData.append('consultation_fee', consultationFee);
            
            // Send request
            fetch('/doctor/update-schedule', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Schedule updated successfully!');
                    closeModal('editScheduleModal');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to update schedule'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }

    // Handle Edit Profile Form
    const editProfileForm = document.getElementById('editProfileForm');
    if (editProfileForm) {
        editProfileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/doctor/update-profile', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile updated successfully!');
                    closeModal('editProfileModal');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to update profile'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }

    // Handle Edit Contact Form
    const editContactForm = document.getElementById('editContactForm');
    if (editContactForm) {
        editContactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/doctor/update-contact', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Contact information updated successfully!');
                    closeModal('editContactModal');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to update contact information'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }

    // Handle Change Password Form
    const changePasswordForm = document.getElementById('changePasswordForm');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            const formData = new FormData(this);
            
            fetch('/doctor/change-password', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password changed successfully!');
                    closeModal('changePasswordModal');
                    this.reset();
                } else {
                    alert('Error: ' + (data.message || 'Failed to change password'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    }
    
    // Appointment approval/rejection functions
    window.approveAppointment = async function(appointmentId, patientName, appointmentDate, appointmentTime) {
        console.log(`[approveAppointment] Called - ID: ${appointmentId}, Patient: ${patientName}`);
        const confirmMsg = `Approve appointment for ${patientName} on ${appointmentDate} at ${appointmentTime}?`;
        
        if (confirm(confirmMsg)) {
            console.log(`[approveAppointment] User confirmed, calling updateAppointmentStatus`);
            await updateAppointmentStatus(appointmentId, 'confirmed');
        } else {
            console.log('[approveAppointment] User cancelled');
        }
    };

    window.rejectAppointment = async function(appointmentId, patientName) {
        console.log(`[rejectAppointment] Called - ID: ${appointmentId}, Patient: ${patientName}`);
        const confirmMsg = `Reject appointment request from ${patientName}?`;
        
        if (confirm(confirmMsg)) {
            console.log(`[rejectAppointment] User confirmed, calling updateAppointmentStatus`);
            await updateAppointmentStatus(appointmentId, 'cancelled');
        } else {
            console.log('[rejectAppointment] User cancelled');
        }
    };

    async function updateAppointmentStatus(appointmentId, status) {
        console.log(`[updateAppointmentStatus] Starting - ID: ${appointmentId}, Status: ${status}`);
        
        try {
            const url = `/doctor/update-appointment/${appointmentId}`;
            console.log(`[updateAppointmentStatus] Fetching: ${url}`);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `status=${status}`
            });
            
            console.log(`[updateAppointmentStatus] Response status: ${response.status}`);
            
            if (!response.ok) {
                console.error(`[updateAppointmentStatus] HTTP error: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('[updateAppointmentStatus] Result:', result);
            
            if (result.success) {
                console.log('[updateAppointmentStatus] Success!');
                alert(`Appointment ${status === 'confirmed' ? 'approved' : 'rejected'} successfully!`);
                window.location.reload();
            } else {
                console.error('[updateAppointmentStatus] Failed:', result.message);
                alert(`Error: ${result.message}`);
            }
            
            return result;
        } catch (error) {
            console.error('[updateAppointmentStatus] Exception:', error);
            alert('Network error occurred. Please try again.\\n\\nCheck the browser console for details.');
            return { success: false, message: 'Network error' };
        }
    }
});

// Patient Details Functionality
let currentlyOpenPatient = null;

async function togglePatientDetails(patientId, button) {
    const detailsRow = document.getElementById(`details-${patientId}`);
    const allDetailsRows = document.querySelectorAll('.patient-details-row');
    const allButtons = document.querySelectorAll('.view-records-btn');
    
    // If clicking the same patient, close it
    if (currentlyOpenPatient === patientId && detailsRow.style.display !== 'none') {
        detailsRow.style.display = 'none';
        button.classList.remove('active');
        button.innerHTML = '<i class="fas fa-folder-open"></i> View Records';
        currentlyOpenPatient = null;
        return;
    }
    
    // Close all other details rows
    allDetailsRows.forEach(row => row.style.display = 'none');
    allButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fas fa-folder-open"></i> View Records';
    });
    
    // Open this details row
    detailsRow.style.display = 'table-row';
    button.classList.add('active');
    button.innerHTML = '<i class="fas fa-folder-minus"></i> Hide Records';
    currentlyOpenPatient = patientId;
    
    // Check if we need to load data
    const container = detailsRow.querySelector('.patient-details-container');
    if (container.querySelector('.loading-spinner')) {
        try {
            const response = await fetch(`/api/doctor/patient/${patientId}/details`);
            if (!response.ok) {
                throw new Error('Failed to fetch patient details');
            }
            
            const data = await response.json();
            renderPatientDetails(container, data);
        } catch (error) {
            console.error('Error fetching patient details:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error loading patient details. Please try again.
                </div>
            `;
        }
    }
}

function renderPatientDetails(container, data) {
    const { patient, appointments, medical_records } = data;
    
    let html = `
        <div class="patient-info-card-expanded">
            <div class="info-header-expanded">
                <div class="patient-avatar-expanded">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="patient-details-expanded">
                    <h3>${patient.username}</h3>
                    <div class="detail-grid-expanded">
                        <div class="detail-item-expanded">
                            <i class="fas fa-envelope"></i>
                            <span>${patient.email}</span>
                        </div>
    `;
    
    if (patient.phone) {
        html += `
                        <div class="detail-item-expanded">
                            <i class="fas fa-phone"></i>
                            <span>${patient.phone}</span>
                        </div>
        `;
    }
    
    if (patient.date_of_birth) {
        html += `
                        <div class="detail-item-expanded">
                            <i class="fas fa-birthday-cake"></i>
                            <span>DOB: ${patient.date_of_birth}</span>
                        </div>
        `;
    }
    
    if (patient.address) {
        html += `
                        <div class="detail-item-expanded">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${patient.address}</span>
                        </div>
        `;
    }
    
    html += `
                    </div>
                </div>
            </div>
            <div class="info-stats-expanded">
                <div class="stat-box-expanded">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div>
                        <h4>${appointments.length}</h4>
                        <p>Total Appointments</p>
                    </div>
                </div>
                <div class="stat-box-expanded" style="margin-left: 15px;">
                    <div class="stat-icon">
                        <i class="fas fa-file-medical"></i>
                    </div>
                    <div>
                        <h4>${medical_records ? medical_records.length : 0}</h4>
                        <p>Medical Records</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Medical Records Section -->
        <div class="medical-records-section">
            <div class="section-header-expanded">
                <h3><i class="fas fa-file-medical-alt"></i> Medical Records</h3>
                <span class="appointment-count-badge-small">
                    <i class="fas fa-folder"></i> ${medical_records ? medical_records.length : 0} Document${(medical_records && medical_records.length !== 1) ? 's' : ''}
                </span>
            </div>
    `;
    
    if (medical_records && medical_records.length > 0) {
        html += `
            <div class="medical-records-grid">
        `;
        
        medical_records.forEach(record => {
            const fileIcon = getFileIcon(record.file_type);
            const fileSize = formatFileSize(record.file_size);
            
            html += `
                <div class="medical-record-card">
                    <div class="record-icon">
                        <i class="fas ${fileIcon}"></i>
                    </div>
                    <div class="record-details">
                        <h4>${record.filename}</h4>
                        <p class="record-meta">
                            <span><i class="fas fa-calendar"></i> ${record.upload_date}</span>
                            <span><i class="fas fa-file"></i> ${fileSize}</span>
                        </p>
                        ${record.description ? `<p class="record-description">${record.description}</p>` : ''}
                    </div>
                    <div class="record-actions">
                        <button onclick="viewRecord('${record.id}')" class="btn btn-sm btn-outline-primary" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="/doctor/download-record/${record.id}" class="btn btn-sm btn-success" title="Download" download>
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                </div>
            `;
        });
        
        html += `
            </div>
        `;
    } else {
        html += `
            <div class="no-data">
                <i class="fas fa-file-medical"></i>
                <p>No medical records uploaded yet.</p>
            </div>
        `;
    }
    
    html += `
        </div>
        
        <div class="appointments-history-section">
            <div class="section-header-expanded">
                <h3><i class="fas fa-history"></i> Appointment History</h3>
                <span class="appointment-count-badge-small">
                    <i class="fas fa-calendar-alt"></i> ${appointments.length} Appointment${appointments.length !== 1 ? 's' : ''}
                </span>
            </div>
    `;
    
    if (appointments.length > 0) {
        html += `
            <div class="appointments-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date & Time</th>
                            <th>Symptoms</th>
                            <th>Status</th>
                            <th>Notes/Prescription</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        appointments.forEach(appt => {
            const statusClass = appt.status === 'confirmed' ? 'confirmed' : appt.status;
            const statusText = appt.status === 'confirmed' ? 'Approved' : appt.status.charAt(0).toUpperCase() + appt.status.slice(1);
            const symptomsText = appt.symptoms ? (appt.symptoms.length > 100 ? appt.symptoms.substring(0, 100) + '...' : appt.symptoms) : '<em class="text-muted">None</em>';
            const notesText = appt.notes ? (appt.notes.length > 100 ? appt.notes.substring(0, 100) + '...' : appt.notes) : '<em class="text-muted">No notes</em>';
            
            html += `
                        <tr>
                            <td>#${appt.id.substring(0, 8)}</td>
                            <td>
                                <div class="datetime-cell">
                                    <span class="date">${appt.appointment_date}</span>
                                    <span class="time">${appt.appointment_time}</span>
                                </div>
                            </td>
                            <td><span class="symptoms-text">${symptomsText}</span></td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td><div class="notes-preview">${notesText}</div></td>
                        </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    } else {
        html += `
            <div class="no-data">
                <i class="fas fa-calendar-times"></i>
                <p>No appointment history found.</p>
            </div>
        `;
    }
    
    html += `
        </div>
    `;
    
    container.innerHTML = html;
}

function getFileIcon(fileType) {
    const iconMap = {
        'pdf': 'fa-file-pdf',
        'image': 'fa-file-image',
        'doc': 'fa-file-word',
        'docx': 'fa-file-word',
        'xls': 'fa-file-excel',
        'xlsx': 'fa-file-excel',
        'txt': 'fa-file-alt',
        'zip': 'fa-file-archive',
        'unknown': 'fa-file'
    };
    return iconMap[fileType] || 'fa-file';
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return 'N/A';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

function viewRecord(recordId) {
    window.open(`/doctor/download-record/${recordId}`, '_blank');
}

</script>
{% endblock %}
