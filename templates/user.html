{% extends "base.html" %}

{% block title %}My Dashboard - Care_4_U Hospitals{% endblock %}

{% block content %}
<div class="user-container">
    <!-- User Profile Header -->
    <div class="profile-header">
        <div class="profile-info">
            <div class="profile-avatar">
                {% if current_user.profile_picture %}
                    <img src="{{ url_for('serve_profile_picture', filename=current_user.profile_picture.split('/')[-1]) }}" alt="{{ current_user.username }}">
                {% else %}
                    <i class="fas fa-user-circle"></i>
                {% endif %}
                <button class="btn-upload-profile" onclick="document.getElementById('profilePictureInput').click()" title="Upload Profile Picture">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="uploadProfilePicture()">
            <div class="profile-details">
                <h2>Welcome, {{ current_user.username }}!</h2>
                <p>{{ current_user.email }}</p>
                {% if current_user.phone %}
                    <p><i class="fas fa-phone"></i> {{ current_user.phone }}</p>
                {% endif %}
                <a href="#" class="btn-edit-profile">
                    <i class="fas fa-edit"></i> Edit Profile
                </a>
            </div>
        </div>
        
        <div class="profile-stats">
            <div class="stat-item">
                <h3>{{ appointments|length }}</h3>
                <p>Total Appointments</p>
            </div>
            <div class="stat-item">
                <h3>{{ appointments|selectattr('status', 'equalto', 'confirmed')|list|length }}</h3>
                <p>Confirmed</p>
            </div>
            <div class="stat-item">
                <h3>{{ appointments|selectattr('status', 'equalto', 'pending')|list|length }}</h3>
                <p>Pending</p>
            </div>
        </div>
    </div>
    
    <!-- Health Information Section -->
    <div class="health-info-section">
        <div class="section-header">
            <h3><i class="fas fa-heart"></i> Health Information</h3>
            <button id="editHealthInfoBtn" class="btn btn-secondary btn-sm" onclick="toggleHealthInfoEdit()">
                <i class="fas fa-edit"></i> Edit
            </button>
        </div>
        
        <div class="health-info-display" id="healthInfoDisplay">
            <div class="health-grid">
                <div class="health-item">
                    <label>Age</label>
                    <p id="displayAge">Not provided</p>
                </div>
                <div class="health-item">
                    <label>Gender</label>
                    <p id="displayGender">Not provided</p>
                </div>
                <div class="health-item">
                    <label>Blood Group</label>
                    <p id="displayBloodGroup">Not provided</p>
                </div>
                <div class="health-item">
                    <label>Allergies</label>
                    <p id="displayAllergies">Not provided</p>
                </div>
                <div class="health-item full-width">
                    <label>Existing Conditions</label>
                    <p id="displayConditions">Not provided</p>
                </div>
            </div>
        </div>
        
        <form id="healthInfoForm" class="health-info-form" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label for="ageInput">Age</label>
                    <input type="number" id="ageInput" min="0" max="150" placeholder="Enter your age">
                </div>
                <div class="form-group">
                    <label for="genderInput">Gender</label>
                    <select id="genderInput">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="Prefer Not to Say">Prefer Not to Say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bloodGroupInput">Blood Group</label>
                    <select id="bloodGroupInput">
                        <option value="">Select Blood Group</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="allergiesInput">Allergies (comma-separated)</label>
                    <input type="text" id="allergiesInput" placeholder="e.g., Penicillin, Shellfish, Pollen">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="conditionsInput">Existing Conditions (comma-separated)</label>
                    <textarea id="conditionsInput" placeholder="e.g., Diabetes, Hypertension, Asthma" rows="3"></textarea>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Health Information
                </button>
                <button type="button" class="btn btn-secondary" onclick="toggleHealthInfoEdit()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="user-actions">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
            <a href="{{ url_for('doctors') }}" class="action-btn primary">
                <i class="fas fa-search"></i>
                <span>Find a Doctor</span>
            </a>
            <button class="action-btn" data-action="upload-document">
                <i class="fas fa-upload"></i>
                <span>Upload Document</span>
            </button>
            <button class="action-btn" data-action="prescriptions">
                <i class="fas fa-prescription-bottle"></i>
                <span>Prescriptions</span>
            </button>
            <button class="action-btn" data-action="view-descriptions">
                <i class="fas fa-info-circle"></i>
                <span>View Descriptions</span>
            </button>
            <button class="action-btn" data-action="medical-records">
                <i class="fas fa-file-medical"></i>
                <span>Medical Records</span>
            </button>
            <button class="action-btn" data-action="notifications">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </button>
        </div>
    </div>
    
    <!-- My Appointments -->
    <div class="appointments-section">
        <div class="section-header">
            <h3>My Appointments</h3>
            <a href="{{ url_for('doctors') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Book New Appointment
            </a>
        </div>
        
        {% if appointments %}
            <div class="appointments-list">
                {% for appointment in appointments %}
                    <div class="appointment-card {{ appointment.status }}">
                        <div class="appointment-header">
                            <div class="appointment-id">
                                <strong>#{{ appointment.id }}</strong>
                                <span class="status-badge {{ appointment.status }}">
                                    {{ appointment.status|title }}
                                </span>
                            </div>
                            <div class="appointment-date">
                                <i class="fas fa-calendar"></i>
                                {{ appointment.appointment_date.strftime('%B %d, %Y') }}
                                <i class="fas fa-clock"></i>
                                {{ appointment.appointment_time }}
                            </div>
                        </div>
                        
                        <div class="appointment-body">
                            <div class="doctor-info">
                                <h4>Dr. {{ appointment.doctor.name }}</h4>
                                <p class="specialization">{{ appointment.doctor.specialization }}</p>
                                <p><i class="fas fa-dollar-sign"></i> Fee: ${{ appointment.doctor.consultation_fee }}</p>
                            </div>
                            
                            {% if appointment.symptoms %}
                                <div class="appointment-notes">
                                    <strong>Symptoms:</strong> {{ appointment.symptoms }}
                                </div>
                            {% endif %}
                            
                            <div class="appointment-created">
                                <small>
                                    Booked on: {{ appointment.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                                </small>
                            </div>
                        </div>
                        
                        <div class="appointment-actions">
                            {% if appointment.status in ['pending', 'confirmed'] %}
                                <a href="{{ url_for('cancel_appointment', appointment_id=appointment.id) }}" 
                                   class="btn btn-danger btn-sm"
                                   onclick="return confirm('Are you sure you want to cancel this appointment?')">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            {% endif %}
                            
                            {% if appointment.status == 'confirmed' %}
                                <button class="btn btn-success btn-sm" onclick="joinVideoCall()">
                                    <i class="fas fa-video"></i> Join Call
                                </button>
                            {% endif %}
                            
                            <button class="btn btn-info btn-sm" onclick="viewDetails({{ appointment.id }})">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            
                            {% if appointment.status == 'completed' %}
                                {% if feedback_dict.get(appointment.id) %}
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="fas fa-check-circle"></i> Feedback Submitted
                                    </button>
                                {% else %}
                                    <button class="btn btn-warning btn-sm" onclick="openFeedbackModal({{ appointment.id }}, '{{ appointment.doctor.name }}')">
                                        <i class="fas fa-star"></i> Rate & Review
                                    </button>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- Feedback Display (if exists) -->
                        {% if appointment.status == 'completed' and feedback_dict.get(appointment.id) %}
                            {% set feedback = feedback_dict.get(appointment.id) %}
                            <div class="feedback-display">
                                <div class="feedback-header">
                                    <strong>Your Feedback</strong>
                                    <div class="star-rating">
                                        {% for i in range(1, 6) %}
                                            <i class="fas fa-star {% if i <= feedback.rating %}active{% endif %}"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% if feedback.comment %}
                                    <p class="feedback-comment">{{ feedback.comment }}</p>
                                {% endif %}
                                <small class="feedback-date">
                                    Submitted on {{ feedback.created_at.strftime('%b %d, %Y') }}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-appointments">
                <i class="fas fa-calendar-times"></i>
                <h4>No Appointments Yet</h4>
                <p>You haven't booked any appointments. Find a doctor and book your first appointment!</p>
                <a href="{{ url_for('doctors') }}" class="btn btn-primary">
                    <i class="fas fa-search"></i> Find a Doctor
                </a>
            </div>
        {% endif %}
    </div>
    
    <!-- Upcoming Appointments -->
    {% if appointments %}
        {% set upcoming = appointments|selectattr('status', 'equalto', 'confirmed')|list %}
        {% if upcoming %}
            <div class="upcoming-section">
                <h3>Upcoming Appointments</h3>
                <div class="upcoming-list">
                    {% for appointment in upcoming[:3] %}
                        <div class="upcoming-card">
                            <div class="upcoming-date">
                                <strong>{{ appointment.appointment_date.strftime('%b %d') }}</strong>
                                <small>{{ appointment.appointment_time }}</small>
                            </div>
                            <div class="upcoming-info">
                                <h5>Dr. {{ appointment.doctor.name }}</h5>
                                <p>{{ appointment.doctor.specialization }}</p>
                                <div class="upcoming-actions">
                                    <button class="btn btn-sm btn-outline">Remind Me</button>
                                    <button class="btn btn-sm btn-outline">Reschedule</button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>

<!-- Prescriptions Modal -->
<div id="prescriptionsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Prescriptions</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            {% if appointments %}
                {% set scripted = appointments|selectattr('notes')|list %}
                {% if scripted %}
                    <div class="appointments-list">
                        {% for app in scripted %}
                            <div class="appointment-card {{ app.status }}">
                                <div class="appointment-header">
                                    <div class="appointment-id">
                                        <strong>#{{ app.id }}</strong>
                                        <span class="status-badge {{ app.status }}">{{ app.status|title }}</span>
                                    </div>
                                    <div class="appointment-date">
                                        {{ app.appointment_date.strftime('%b %d, %Y') }} — {{ app.appointment_time }}
                                    </div>
                                </div>
                                <div class="appointment-body">
                                    <div class="doctor-info">
                                        <h4>Dr. {{ app.doctor.name }}</h4>
                                        <p class="specialization">{{ app.doctor.specialization }}</p>
                                    </div>
                                    <div class="appointment-notes">
                                        <strong>Prescription / Notes:</strong> {{ app.notes }}
                                    </div>
                                    {% if app.symptoms %}
                                        <div class="appointment-notes">
                                            <strong>Symptoms:</strong> {{ app.symptoms }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-prescription"></i>
                        <p>No prescriptions available yet.</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="no-data">
                    <i class="fas fa-prescription"></i>
                    <p>No appointments found.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Profile</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="edit_username">Username</label>
                    <input type="text" id="edit_username" value="{{ current_user.username }}">
                </div>
                <div class="form-group">
                    <label for="edit_email">Email</label>
                    <input type="email" id="edit_email" value="{{ current_user.email }}">
                </div>
                <div class="form-group">
                    <label for="edit_phone">Phone Number</label>
                    <input type="tel" id="edit_phone" value="{{ current_user.phone or '' }}">
                </div>
                <div class="form-group">
                    <label for="edit_address">Address</label>
                    <textarea id="edit_address" rows="3">{{ current_user.address or '' }}</textarea>
                </div>
                <div class="form-group">
                    <label for="edit_dob">Date of Birth</label>
                    <input type="date" id="edit_dob">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div id="uploadDocumentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Document</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="uploadDocumentForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="document_file">Choose File <span class="required">*</span></label>
                    <input type="file" id="document_file" name="document" accept=".pdf,.jpg,.jpeg,.png" required>
                    <small class="form-help">Allowed: PDF, JPG, PNG</small>
                </div>
                <div class="form-group">
                    <label for="document_desc">Description</label>
                    <textarea id="document_desc" name="description" rows="3" placeholder="Optional description"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-upload"></i> Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Descriptions Modal -->
<div id="descriptionsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Appointment Descriptions</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            {% if appointments %}
                {% set described = [] %}
                {% for app in appointments %}
                    {% if app.symptoms %}
                        {% set described = described + [app] %}
                    {% endif %}
                {% endfor %}
                
                {% if described %}
                    <div class="appointments-list">
                        {% for app in described %}
                            <div class="appointment-card {{ app.status }}">
                                <div class="appointment-header">
                                    <div class="appointment-id">
                                        <strong>#{{ app.id }}</strong>
                                        <span class="status-badge {{ app.status }}">{{ app.status|title }}</span>
                                    </div>
                                    <div class="appointment-date">
                                        {{ app.appointment_date.strftime('%b %d, %Y') }} — {{ app.appointment_time }}
                                    </div>
                                </div>
                                <div class="appointment-body">
                                    <div class="doctor-info">
                                        <h4>Dr. {{ app.doctor.name }}</h4>
                                        <p class="specialization">{{ app.doctor.specialization }}</p>
                                    </div>
                                    <div class="appointment-notes">
                                        <strong>Symptoms:</strong> {{ app.symptoms }}
                                    </div>
                                    {% if app.notes %}
                                        <div class="appointment-notes">
                                            <strong>Doctor Notes:</strong> {{ app.notes }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-info-circle"></i>
                        <p>No descriptions available yet. Book an appointment and add symptoms to see them here.</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="no-data">
                    <i class="fas fa-info-circle"></i>
                    <p>No appointments found.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Medical Records Modal -->
<div id="recordsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Medical Records</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            {% if appointments %}
                <div class="appointments-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Doctor</th>
                                <th>Specialization</th>
                                <th>Status</th>
                                <th>Symptoms / Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in appointments %}
                                <tr>
                                    <td>{{ app.appointment_date.strftime('%b %d, %Y') }}</td>
                                    <td>{{ app.doctor.name }}</td>
                                    <td>{{ app.doctor.specialization }}</td>
                                    <td><span class="status-badge {{ app.status }}">{{ app.status|title }}</span></td>
                                    <td>
                                        {% if app.symptoms %}<div><strong>Symptoms:</strong> {{ app.symptoms }}</div>{% endif %}
                                        {% if app.notes %}<div><strong>Notes:</strong> {{ app.notes }}</div>{% endif %}
                                        {% if not app.symptoms and not app.notes %}<em>None</em>{% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-data">
                    <i class="fas fa-file-medical"></i>
                    <p>No records available.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Notifications Modal -->
<div id="notificationsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Notifications</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            {% set notif_list = appointments|map(attribute='status')|list if appointments else [] %}
            {% if appointments %}
                <ul class="today-list">
                    {% for app in appointments[:5] %}
                        <li>
                            <strong>Appointment #{{ app.id }}</strong>
                            <span class="status-badge {{ app.status }}">{{ app.status|title }}</span>
                            <small>{{ app.appointment_date.strftime('%b %d, %Y') }} at {{ app.appointment_time }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="no-data">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Floating AI Health Assistant Button -->
<button id="floatingAiBtn" class="floating-ai-btn" title="Open AI Health Assistant">
    <i class="fas fa-robot"></i>
</button>

<!-- AI Health Assistant Modal -->
<div id="aiAssistantModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-robot"></i> AI Health Assistant</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="chatbot-container">
                <div id="chatMessages" class="chat-messages">
                    <div class="chat-message bot">
                        <div class="message-content">
                            <p>Hello! I'm your AI Health Assistant. I can help you:</p>
                            <ul>
                                <li>Analyze your symptoms</li>
                                <li>Suggest appropriate doctor specializations</li>
                                <li>Detect if you need emergency care</li>
                                <li>Help you book an appointment</li>
                            </ul>
                            <p><strong>Please describe your symptoms:</strong></p>
                        </div>
                    </div>
                </div>
                <form id="chatForm" class="chat-input-area">
                    <textarea id="symptomInput" placeholder="e.g., I have severe chest pain and difficulty breathing..." rows="3" required></textarea>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Health Information Management (localStorage)
function loadHealthInfo() {
    const healthData = JSON.parse(localStorage.getItem('userHealthInfo') || '{}');
    
    document.getElementById('displayAge').textContent = healthData.age || 'Not provided';
    document.getElementById('displayGender').textContent = healthData.gender || 'Not provided';
    document.getElementById('displayBloodGroup').textContent = healthData.bloodGroup || 'Not provided';
    document.getElementById('displayAllergies').textContent = healthData.allergies || 'Not provided';
    document.getElementById('displayConditions').textContent = healthData.conditions || 'Not provided';
    
    document.getElementById('ageInput').value = healthData.age || '';
    document.getElementById('genderInput').value = healthData.gender || '';
    document.getElementById('bloodGroupInput').value = healthData.bloodGroup || '';
    document.getElementById('allergiesInput').value = healthData.allergies || '';
    document.getElementById('conditionsInput').value = healthData.conditions || '';
}

function toggleHealthInfoEdit() {
    const form = document.getElementById('healthInfoForm');
    const display = document.getElementById('healthInfoDisplay');
    const isHidden = form.style.display === 'none';
    
    form.style.display = isHidden ? 'block' : 'none';
    display.style.display = isHidden ? 'none' : 'block';
}

function saveHealthInfo(e) {
    e.preventDefault();
    
    const healthData = {
        age: document.getElementById('ageInput').value,
        gender: document.getElementById('genderInput').value,
        bloodGroup: document.getElementById('bloodGroupInput').value,
        allergies: document.getElementById('allergiesInput').value,
        conditions: document.getElementById('conditionsInput').value
    };
    
    localStorage.setItem('userHealthInfo', JSON.stringify(healthData));
    loadHealthInfo();
    toggleHealthInfoEdit();
    alert('Health information saved successfully!');
}

document.addEventListener('DOMContentLoaded', function() {
    // Load health info on page load
    loadHealthInfo();
    
    // Handle health info form submission
    const healthForm = document.getElementById('healthInfoForm');
    if (healthForm) {
        healthForm.addEventListener('submit', saveHealthInfo);
    }
    
    // Edit Profile Modal

    const editModal = document.getElementById('editProfileModal');
    const editProfileBtn = document.querySelector('.btn-edit-profile');
    const closeModalBtns = document.querySelectorAll('.close-modal');
    const descriptionsModal = document.getElementById('descriptionsModal');
    const recordsModal = document.getElementById('recordsModal');
    const notificationsModal = document.getElementById('notificationsModal');
    const prescriptionsModal = document.getElementById('prescriptionsModal');
    const uploadDocumentModal = document.getElementById('uploadDocumentModal');
    const aiAssistantModal = document.getElementById('aiAssistantModal');
    const actionButtons = {
        ai: document.querySelector('[data-action="ai-assistant"]'),
        upload: document.querySelector('[data-action="upload-document"]'),
        prescriptions: document.querySelector('[data-action="prescriptions"]'),
        descriptions: document.querySelector('[data-action="view-descriptions"]'),
        records: document.querySelector('[data-action="medical-records"]'),
        notifications: document.querySelector('[data-action="notifications"]')
    };
    
    editProfileBtn.addEventListener('click', (e) => {
        e.preventDefault();
        editModal.style.display = 'block';
    });

    const openModal = (modalEl) => {
        if (!modalEl) return;
        modalEl.style.display = 'flex';
    };

    // Floating AI button
    const floatingAiBtn = document.getElementById('floatingAiBtn');
    floatingAiBtn?.addEventListener('click', () => openModal(aiAssistantModal));

    actionButtons.ai?.addEventListener('click', () => openModal(aiAssistantModal));
    actionButtons.upload?.addEventListener('click', () => openModal(uploadDocumentModal));
    actionButtons.prescriptions?.addEventListener('click', () => openModal(prescriptionsModal));
    actionButtons.descriptions?.addEventListener('click', () => openModal(descriptionsModal));
    actionButtons.records?.addEventListener('click', () => openModal(recordsModal));
    actionButtons.notifications?.addEventListener('click', () => openModal(notificationsModal));
    
    closeModalBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            [editModal, uploadDocumentModal, prescriptionsModal, descriptionsModal, recordsModal, notificationsModal, aiAssistantModal].forEach(m => {
                if (m) m.style.display = 'none';
            });
        });
    });
    
    window.addEventListener('click', (e) => {
        [editModal, uploadDocumentModal, prescriptionsModal, descriptionsModal, recordsModal, notificationsModal, aiAssistantModal].forEach(m => {
            if (e.target === m) {
                m.style.display = 'none';
            }
        });
    });
    
    // Upload Profile Picture
    function uploadProfilePicture() {
        const fileInput = document.getElementById('profilePictureInput');
        if (!fileInput.files.length) return;
        
        const formData = new FormData();
        formData.append('profile_picture', fileInput.files[0]);
        
        fetch('/upload-profile-picture', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Profile picture updated successfully');
                // Reload the page to show the new picture
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Upload failed. Please try again.');
        });
    }

    // Upload Document Form
    const uploadDocumentForm = document.getElementById('uploadDocumentForm');
    if (uploadDocumentForm) {
        uploadDocumentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('document_file');
            if (!fileInput.files.length) {
                alert('Please choose a file to upload.');
                return;
            }
            const formData = new FormData(this);
            fetch('/user/upload-document', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Document uploaded successfully');
                    uploadDocumentModal.style.display = 'none';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Upload failed. Please try again.');
            });
        });
    }

    // AI Chatbot Form
    const chatForm = document.getElementById('chatForm');
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const symptomInput = document.getElementById('symptomInput');
            const userMessage = symptomInput.value.trim();
            
            if (!userMessage) return;

            // Add user message to chat
            addChatMessage('user', userMessage);
            symptomInput.value = '';

            // Send to backend
            fetch('/user/chat-assistant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symptoms: userMessage })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    addChatMessage('bot', data.response, data);
                } else {
                    addChatMessage('bot', 'Sorry, I encountered an error. Please try again.');
                }
            })
            .catch(err => {
                console.error('Error:', err);
                addChatMessage('bot', 'Sorry, I encountered a connection error. Please try again.');
            });
        });
    }

    // Chat message helper
    function addChatMessage(sender, text, data = null) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}`;
        
        let html = `<div class="message-bubble">`;
        
        if (sender === 'bot' && data) {
            // For bot messages with data, render HTML content
            html += `<div class="message-content">${text}</div>`;
            
            if (data.is_emergency) {
                html += `<div class="emergency-warning"><i class="fas fa-exclamation-triangle"></i><span class="emergency-warning-text">⚠️ EMERGENCY DETECTED - SEEK IMMEDIATE MEDICAL ATTENTION</span></div>`;
            }
            
            if (data.specializations && data.specializations.length > 0) {
                html += `<div class="recommendations">
                    <h4><i class="fas fa-stethoscope"></i> Recommended Specializations</h4>
                    <ul class="recommendation-list">`;
                data.specializations.forEach(spec => {
                    const specNameSafe = escapeHtml(spec.name);
                    html += `<li class="recommendation-item">
                        <span class="spec-name">${specNameSafe}</span>
                        <span class="spec-reason">${escapeHtml(spec.reason)}</span>
                        <button class="book-btn" onclick="bookAppointment('${specNameSafe}')"><i class="fas fa-calendar-check"></i> Book</button>
                    </li>`;
                });
                html += `</ul></div>`;
            }
            
            if (data.severity_score !== undefined) {
                const severity = Math.round(data.severity_score);
                const color = severity > 70 ? '#ef4444' : severity > 40 ? '#f59e0b' : '#10b981';
                html += `<div class="severity-score">
                    <span class="severity-label">Severity Level:</span>
                    <div class="severity-bar">
                        <div class="severity-fill" style="width: ${severity}%; background: linear-gradient(90deg, #fbbf24, #f59e0b);">
                            ${severity}%
                        </div>
                    </div>
                </div>`;
            }
        } else {
            // For user messages and simple bot messages
            html += `<p>${sender === 'bot' ? text : escapeHtml(text)}</p>`;
        }
        
        html += '</div>';
        messageDiv.innerHTML = html;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    window.bookAppointment = function(specialization) {
        window.location.href = '/doctors?specialization=' + encodeURIComponent(specialization);
    };
    
    // Edit Profile Form
    const editProfileForm = document.getElementById('editProfileForm');
    editProfileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Profile update functionality would be implemented here.');
        editModal.style.display = 'none';
    });
});

function joinVideoCall() {
    alert('Video call functionality would be implemented here.\nThis would connect to services like Zoom, Google Meet, or a custom WebRTC solution.');
}

function viewDetails(appointmentId) {
    alert(`Viewing detailed information for appointment #${appointmentId}`);
}

// Feedback Modal Functions
function openFeedbackModal(appointmentId, doctorName) {
    document.getElementById('feedbackAppointmentId').value = appointmentId;
    document.getElementById('feedbackDoctorName').textContent = doctorName;
    document.getElementById('feedbackModal').style.display = 'flex';
    resetStarRating();
}

function closeFeedbackModal() {
    document.getElementById('feedbackModal').style.display = 'none';
    document.getElementById('feedbackForm').reset();
    resetStarRating();
}

function resetStarRating() {
    const stars = document.querySelectorAll('.star-input');
    stars.forEach(star => star.classList.remove('active'));
    document.getElementById('feedbackRating').value = '';
}

function setRating(rating) {
    document.getElementById('feedbackRating').value = rating;
    const stars = document.querySelectorAll('.star-input');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

// Submit Feedback
document.addEventListener('DOMContentLoaded', function() {
    const feedbackForm = document.getElementById('feedbackForm');
    if (feedbackForm) {
        feedbackForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const appointmentId = document.getElementById('feedbackAppointmentId').value;
            const rating = document.getElementById('feedbackRating').value;
            const comment = document.getElementById('feedbackComment').value;
            
            if (!rating) {
                alert('Please select a star rating');
                return;
            }
            
            const formData = new FormData();
            formData.append('rating', rating);
            formData.append('comment', comment);
            
            fetch(`/submit-feedback/${appointmentId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeFeedbackModal();
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting feedback');
            });
        });
    }
});
</script>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal" style="display: none;">
    <div class="modal-content feedback-modal">
        <div class="modal-header">
            <h3><i class="fas fa-star"></i> Rate Your Experience</h3>
            <button class="close-modal" onclick="closeFeedbackModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="feedbackForm">
                <input type="hidden" id="feedbackAppointmentId">
                <input type="hidden" id="feedbackRating">
                
                <div class="feedback-doctor">
                    <p>How was your appointment with <strong id="feedbackDoctorName"></strong>?</p>
                </div>
                
                <div class="star-rating-input">
                    <p class="rating-label">Your Rating:</p>
                    <div class="stars-container">
                        <i class="fas fa-star star-input" onclick="setRating(1)"></i>
                        <i class="fas fa-star star-input" onclick="setRating(2)"></i>
                        <i class="fas fa-star star-input" onclick="setRating(3)"></i>
                        <i class="fas fa-star star-input" onclick="setRating(4)"></i>
                        <i class="fas fa-star star-input" onclick="setRating(5)"></i>
                    </div>
                    <p class="rating-description" id="ratingDescription">Click to rate</p>
                </div>
                
                <div class="form-group">
                    <label for="feedbackComment">Your Comments (Optional):</label>
                    <textarea id="feedbackComment" name="comment" rows="4" 
                              placeholder="Tell us about your experience..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.feedback-modal {
    max-width: 500px;
}

.feedback-doctor {
    text-align: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--gray-lighter);
    border-radius: var(--border-radius-sm);
}

.feedback-doctor p {
    margin: 0;
    font-size: 1.1rem;
    color: var(--dark);
}

.star-rating-input {
    text-align: center;
    margin: 2rem 0;
}

.rating-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 1rem;
}

.stars-container {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin: 1rem 0;
}

.star-input {
    font-size: 2.5rem;
    color: var(--gray-light);
    cursor: pointer;
    transition: all 0.2s ease;
}

.star-input:hover {
    color: #fbbf24;
    transform: scale(1.2);
}

.star-input.active {
    color: #fbbf24;
}

.rating-description {
    font-size: 0.875rem;
    color: var(--gray);
    margin-top: 0.5rem;
}

.feedback-display {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--primary-light);
    border-left: 4px solid var(--primary);
    border-radius: var(--border-radius-sm);
}

.feedback-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.feedback-header strong {
    color: var(--dark);
    font-size: 0.9rem;
}

.feedback-display .star-rating {
    display: flex;
    gap: 0.2rem;
}

.feedback-display .star-rating i {
    font-size: 0.9rem;
    color: var(--gray-light);
}

.feedback-display .star-rating i.active {
    color: #fbbf24;
}

.feedback-comment {
    margin: 0.75rem 0;
    color: var(--dark);
    font-size: 0.875rem;
    font-style: italic;
    line-height: 1.5;
}

.feedback-date {
    color: var(--gray);
    font-size: 0.75rem;
}
</style>

{% endblock %}